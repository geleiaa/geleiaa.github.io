<!doctype html> <html lang=""> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> mem-corruption lab RPISEC | Geleia </title> <meta name="author" content="Geleia "> <meta name="description" content="rpisec lab2C"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://geleiaa.github.io/blog/2023/mem_corruption_lab/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Geleia</span> </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">mem-corruption lab RPISEC</h1> <p class="post-meta"> December 04, 2023 </p> <p class="post-tags"> <a href="/blog/2023"> <i class="fa-solid fa-calendar fa-sm"></i> 2023 </a> &nbsp; &middot; &nbsp; <a href="/blog/category/rpisec"> <i class="fa-solid fa-tag fa-sm"></i> rpisec</a> &nbsp; <a href="/blog/category/bin-exp"> <i class="fa-solid fa-tag fa-sm"></i> bin-exp</a> &nbsp; </p> </header> <article class="post-content"> <div id="markdown-content"> <h3 id="solving-lab2c-0213---memory-corruption-lab-httpsgithubcomrpisecmbeblobmastersrclab02lab2cc">Solving lab2C “02/13 | –[ Memory Corruption Lab” (https://github.com/RPISEC/MBE/blob/master/src/lab02/lab2C.c)</h3> <h3 id="this-lab-is-a-simple-buffer-overflow-the-intention-of-this-lab-was-to-explore-bof-and-get-a-shell-from-the-lab-machine-and-then-get-the-flag-but-here-we-wont-have-the-shell-part">This lab is a simple buffer-overflow. The intention of this lab was to explore bof and get a shell from the lab machine and then get the flag. But here we won’t have the shell part.</h3> <p>First we go get the source code and compile following the instruction that is commented in the code:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/compilelab2ccode.png" class="img-fluid rounded z-depth-1" width="400" height="400" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc -O0 -fno-stack-protector lab2C.c -o lab2C
</code></pre></div></div> <p>Running the binary we see how to use it:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/binusage.png" class="img-fluid rounded z-depth-1" width="200" height="200" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Running with a string the binary shows that we are not “authenticated” and set_me is 0. It seems that the binary needs a specific string/password:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/notauth.png" class="img-fluid rounded z-depth-1" width="200" height="200" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Looking at the binary disassembly, we see that the <strong>strcpy</strong> function is called before a comparison of a memory address with the “0xdeadbeef” bytes. And if this comparison is not true, the flow jumps to the end, prints something and ends execution. But if the comparison is true, a “shell” function will be called.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ objdump -dM intel lab2C | grep -A40 "&lt;main&gt;:"
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/jmp.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Looking at the disassembly of the shell function, we don’t see much useful stuff, just a <strong>puts</strong> function that can display some string and we also see a <strong>system</strong> function being called.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ objdump -dM intel lab2C | grep -A12 "&lt;shell&gt;:"
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/disasshell.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <h3 id="now-lets-debug-the-binary-to-see-what-it-does">Now let’s debug the binary to see what it does</h3> <p>Looking at the disassembly with gdb + peda we can better see the execution flow of the main function:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/gdbdisas.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Running the binary in gdb without passing any input string, the flow is diverted to a <strong>printf</strong> that shows the usage and then a jump throws the flow to the end of the execution:</p> <ul> <li>check input (<strong>cmp DWORD PTR [rbp-0x24],0x2</strong>)</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/withoutarg1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>if not have input, print the usage</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/withoutarg2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>jump to the end</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/withoutarg3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <h3 id="since-the-binary-needs-an-input-lets-set-a-breakpoint-in-the-main-and-run-binary-with-an-input-string">Since the binary needs an input let’s set a breakpoint in the main and run binary with an input string…</h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ b main
</code></pre></div></div> <p>(breakpoint)</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ r GELEIA
</code></pre></div></div> <p>(run binary with “GELEIA” string)</p> <p>Now running with a input the exec flow throws us to another place. First compare if have any args, so <strong>je</strong> (jump equal) go to address <strong>&lt;main+59&gt;</strong>.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/witharg1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>After some steps we arrive at the <strong>strcpy</strong> function that we saw before. We can see that the input is moved through the registers until it reaches the <strong>strcpy</strong> function. And probably the input is copied somewhere by the <strong>strcpy</strong> function. Soon after, a comparison of address <strong>DWORD PTR [rbp-0x4]</strong> with “0xdeadbeef” takes place.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/witharg2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>After comparing if <strong>DWORD PTR [rbp-0x4]</strong> address is equal to “0xdeadbeef” the flow jump to “shell” function. If not equal the flow jump to a <strong>printf</strong> with a message “Not authenticated. set_me was 0” and finishe execution.</p> <ul> <li>jump to end</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/witharg3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>print message and finishes</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/witharg4.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <h3 id="now-is-the-buffer-overflow">Now is the Buffer Overflow</h3> <p>Knowing that the given input is stored somewhere, we can overwrite the memory after the input is stored so we can control what will be compared. If this works, we will bypass the check.</p> <p>First we need to know how many bytes can be stored in the variable (or how much memory has been allocated to that variable). To do this, we will send a large number of bytes to the binary input and see how it handles that.</p> <p>The input will be this: “AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEE”.</p> <p>This way we can know how many bytes the variable stores and when there was a memory leak. For example, if the variable stores the value until the end of the letters “B”, then we know that after the “B” the memory following the variable was overwritten.</p> <h3 id="lets-go">Let’s go</h3> <p>First let’s run the binary with gdb then set a breakpoint in main and then send the buffer to the binary like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ r $(echo 'AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEE')
</code></pre></div></div> <p>Getting close to the part that checks the input we can see the alphabet buffer being moved through the registers</p> <ul> <li>first buffer go to <strong>RAX</strong> after go to <strong>RDX</strong></li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/buffmove1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/buffmove2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Passing in <strong>strcpy</strong> function the buffer is stored and after this the address <strong>DWORD PTR [rbp-0x4]</strong> will be compared.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/compare1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>So if we look at what’s at that address, we see the bytes that overwrote the memory after the leak:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/compare2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Basically the variable that stores the input has a limit of 15 bytes. Example:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEE
|   1 to 15   ||       16 to 40        |
|_____________||_______________________|
this is stored  this overwrite the next memory

</code></pre></div></div> <p>Knowing this we can overwrite the next memory (after 15 bytes) with the “0xdeadbeef” bytes and bypass the check. That way:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AAAAAAAABBBBBBB0xdeadbeef
</code></pre></div></div> <h3 id="so-lets-go">So let’s go</h3> <p>Using a python code to make it easier, we will print the buffer and send it to the binary input. The exploit looks like this:</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">struct</span>

<span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x41</span><span class="sh">'</span> <span class="o">*</span> <span class="mi">15</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">'</span><span class="s">&lt;Q</span><span class="sh">'</span><span class="p">,</span> <span class="mh">0xdeadbeef</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">exp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</code></pre></div></div> <p>Running the exploit will send the buffer to a file called exp. And when we run the binary we will send the file contents to the input, like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ r $(cat exp)
</code></pre></div></div> <p>Then let’s move on to the part that matters:</p> <ul> <li>we can see the exploration buffer being moved.</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exp1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>Coming to the comparison, we see that the buffer overwrote the variable where it is stored and went to the memory of the next instruction.</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exp2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exp3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>Since we have the memory overwritten, then the execution flow goes to the shell function as expected.</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exp4.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exp5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>Now we get to the shell function and see what’s in it.</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exp6.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>So it looks like we did this…</p> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> 2024 Geleia . </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>